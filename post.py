import os, re, asyncio
from telegram import Bot
from openai import OpenAI


PROMPT = """
–¢—ã ‚Äî ¬´Vaybo–ú–µ—Ç—Ä¬ª, –ø—Ä–∏—Å—ã–ª–∞–π –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–π –≤–∞–π–±-–¥–∞–π–¥–∂–µ—Å—Ç –¥–ª—è –∂–∏—Ç–µ–ª–µ–π –õ–∏–º–∞—Å—Å–æ–ª–∞
–°–¢–†–û–ì–û –≤ —Ç–∞–∫–æ–º –≤–∏–¥–µ (–∏—Å–ø–æ–ª—å–∑—É–π <b> –¥–ª—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, –æ–±—ã—á–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫–∏
–º–µ–∂–¥—É —Å—Ç—Ä–æ–∫–∞–º–∏, –ù–ò–ö–ê–ö–ò–• ``` –∏ \\n, –Ω–∏–∫–∞–∫–∏—Ö –¥—Ä—É–≥–∏—Ö html-—Ç–µ–≥–æ–≤):

<b>‚òÄÔ∏è –ü–æ–≥–æ–¥–∞</b>
–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ‚Ä¶ ¬∞C
–û–±–ª–∞—á–Ω–æ—Å—Ç—å: ‚Ä¶
–û—Å–∞–¥–∫–∏: ‚Ä¶
–í–µ—Ç–µ—Ä: ‚Ä¶

<b>üå¨Ô∏è –ö–∞—á–µ—Å—Ç–≤–æ –≤–æ–∑–¥—É—Ö–∞</b>
–ò–Ω–¥–µ–∫—Å AQI: ‚Ä¶ (‚Ä¶)
PM2.5: ‚Ä¶ ¬µg/m¬≥
PM10: ‚Ä¶ ¬µg/m¬≥
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ‚Ä¶

<b>üåø –£—Ä–æ–≤–µ–Ω—å –ø—ã–ª—å—Ü—ã</b>
–î–µ—Ä–µ–≤—å—è: ‚Ä¶
–¢—Ä–∞–≤—ã: ‚Ä¶
–ê–º–±—Ä–æ–∑–∏—è: ‚Ä¶
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ‚Ä¶

<b>üåå –ì–µ–æ–º–∞–≥–Ω–∏—Ç–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</b>
–£—Ä–æ–≤–µ–Ω—å: ‚Ä¶
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ‚Ä¶

<b>üìà –†–µ–∑–æ–Ω–∞–Ω—Å –®—É–º–∞–Ω–∞</b>
–§–æ–Ω–æ–≤–∞—è —á–∞—Å—Ç–æ—Ç–∞: ‚Ä¶
–ê–º–ø–ª–∏—Ç—É–¥–∞: ‚Ä¶

<b>üåä –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤–æ–¥—ã –≤ –º–æ—Ä–µ</b>
–°–µ–π—á–∞—Å: ‚Ä¶ ¬∞C
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ‚Ä¶

<b>üîÆ –ê—Å—Ç—Ä–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è</b>
–°–æ–±—ã—Ç–∏–µ 1: ‚Ä¶
–°–æ–±—ã—Ç–∏–µ 2: ‚Ä¶

<b>‚úÖ –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</b>
‚Äì ‚Ä¶
‚Äì ‚Ä¶
‚Äì ‚Ä¶

–ë—É–¥—å—Ç–µ –Ω–∞ –≤–æ–ª–Ω–µ –∏ —Å–ª—É—à–∞–π—Ç–µ —Å–≤–æ—ë —Ç–µ–ª–æ!
"""

def fetch_digest() -> str:
    client = OpenAI(api_key=os.environ["OPENAI_API_KEY"])
    resp = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "user", "content": PROMPT}],
        temperature=0.7,
    )
    text = resp.choices[0].message.content.strip()

    # —É–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ–µ –æ–±—Ä–∞–º–ª–µ–Ω–∏–µ –≤ ``` (–º–æ–¥–µ–ª—å –≤–¥—Ä—É–≥ ¬´—Ä–µ—à–∏—Ç –ø–æ–º–æ—á—å¬ª)
    text = re.sub(r"^```[^\n]*\n|\n```$", "", text, flags=re.S)
    # –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞: –∑–∞–º–µ–Ω—è–µ–º –ª–∏—Ç–µ—Ä–∞–ª—å–Ω—ã–µ \n –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–≤–æ–¥—ã
    text = text.replace("\\n", "\n")

    return text

async def post_to_telegram(text: str) -> None:
    bot = Bot(token=os.environ["TELEGRAM_TOKEN"])
    await bot.send_message(
        chat_id=os.environ["CHANNEL_ID"],
        text=text,
        parse_mode="HTML",
        disable_web_page_preview=True,
    )

async def main():
    digest = fetch_digest()
    await post_to_telegram(digest)

if __name__ == "__main__":
    asyncio.run(main())
