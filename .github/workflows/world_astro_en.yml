name: world-astro-en

on:
  schedule:
    - cron: "5 17 * * *"   # 17:05 UTC каждый день
  workflow_dispatch:
    inputs:
      publish_to:
        description: "Куда публиковать?"
        type: choice
        required: false
        default: both
        options:
          - both       # Телеграм + Facebook
          - telegram   # только основной Телеграм
          - facebook   # только Facebook-страница
          - test       # тестовый Телеграм
      send_to_test:
        description: "(deprecated) Send to TEST channel instead of main"
        type: boolean
        default: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: UTC
      PYTHONPATH: ${{ github.workspace }}

      # ── секреты/настройки публикации ─────────────────────────────
      # поднимем секреты в env (так безопаснее использовать их в if:)
      FB_PAGE_ID: ${{ secrets.FB_PAGE_ID || '' }}
      FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN || '' }}
      TG_URL: ${{ secrets.TELEGRAM_CHANNEL_URL || 'https://t.me/WorldVibeMeter' }}

      # ── imagegen keys ───────────────────────────────────────────
      STABLE_HORDE_API_KEY: ${{ secrets.STABLE_HORDE_API_KEY || '' }}
      POLLINATIONS_TOKEN: ${{ secrets.POLLINATIONS_TOKEN || '' }}

      # (опционально) можно увеличить таймаут Pollinations, чтобы реже ловить timeout
      POLLINATIONS_TIMEOUT: "45"
      # (опционально) общее число попыток генерации поверх всех бэкендов
      IMAGEGEN_MAX_ATTEMPTS: "3"

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Debug image keys presence
        run: |
          python - <<'PY'
          import os
          print("Has POLLINATIONS_TOKEN:", bool(os.getenv("POLLINATIONS_TOKEN")))
          print("Has STABLE_HORDE_API_KEY:", bool(os.getenv("STABLE_HORDE_API_KEY")))
          PY

      # 1) Сбор данных -> world_en/astro.json (+ попытка генерации изображения)
      - name: Collect Astro
        run: |
          python -u world_en/world_astro_collect.py
          echo "---- ls world_en"; ls -l world_en
          echo "---- head astro.json"; head -c 400 world_en/astro.json || true

      # 1.1) Инспекция выходов (наличие изображения)
      - name: Inspect outputs
        run: |
          echo "---- head astro.json"; head -c 600 world_en/astro.json || true
          echo "---- ls astro_img (repo root)"; ls -l astro_img || true

      # 2) Проверка наличия astro.json
      - name: Verify astro.json exists
        run: |
          test -f world_en/astro.json || { echo "ERROR: world_en/astro.json was not created"; exit 1; }
          echo "[astro] wrote: world_en/astro.json"

      # 3) Рендер сообщения
      - name: Render
        run: python world_en/render.py world_en/templates/astro_en.j2 world_en/astro.json > world_en/astro_msg.txt

      # ===================== TELEGRAM (MAIN) =====================
      - name: Send to MAIN Telegram
        if: ${{ github.event_name == 'schedule'
            || github.event.inputs.publish_to == 'both'
            || github.event.inputs.publish_to == 'telegram'
            || (github.event.inputs.publish_to == '' && github.event.inputs.send_to_test != 'true') }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN_EN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID_EN }}
        run: |
          set -euo pipefail

          IMG_PATH="$(python - <<'PY'
          import json, os, pathlib
          p = 'world_en/astro.json'
          try:
              data = json.loads(pathlib.Path(p).read_text('utf-8'))
              cand = data.get('ASTRO_IMAGE_PATH') or data.get('ASTRO_IMAGE_PATH_REL') or ''
              if cand and os.path.exists(cand):
                  print(cand, end='')
          except Exception:
              pass
          PY
          )"

          echo "Telegram MAIN IMG_PATH='${IMG_PATH}'"

          if [ -n "${IMG_PATH:-}" ] && [ -f "$IMG_PATH" ]; then
            echo "Sending sendPhoto with: $IMG_PATH"
            CAPTION="$(python - <<'PY'
          import pathlib
          t = pathlib.Path('world_en/astro_msg.txt').read_text('utf-8', errors='ignore')
          print(t[:1000], end='')
          PY
            )"
            curl -sS -f -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendPhoto" \
              -F "chat_id=${TG_CHAT}" \
              -F "photo=@${IMG_PATH}" \
              -F "caption=${CAPTION}" \
              -F "parse_mode=HTML" \
            | sed 's/\\u[0-9a-fA-F]\{4\}//g'
          else
            echo "No image found — sending text"
            curl -sS -f -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
              -d chat_id="${TG_CHAT}" -d parse_mode="HTML" \
              --data-urlencode text@"world_en/astro_msg.txt"
          fi

      # ===================== FACEBOOK =====================
      - name: Build Facebook-safe text
        if: ${{ (github.event_name == 'schedule'
            || github.event.inputs.publish_to == 'both'
            || github.event.inputs.publish_to == 'facebook')
            && env.FB_PAGE_ID != '' && env.FB_PAGE_TOKEN != '' }}
        run: |
          python - <<'PY'
          import re, html, pathlib, os
          p = pathlib.Path('world_en/astro_msg.txt').read_text('utf-8', errors='ignore')
          # уберём HTML, экранирование и подчистим пустые строки
          plain = re.sub(r'<[^>]+>', '', p)
          plain = html.unescape(plain)
          plain = re.sub(r'[ \t]+\n', '\n', plain)
          plain = re.sub(r'\n{3,}', '\n\n', plain).strip()
          # компактный лимит для FB-поста
          if len(plain) > 2500:
              plain = plain[:2490].rsplit('\n', 1)[0] + '\n…'
          link = os.getenv('TG_URL') or 'https://t.me/WorldVibeMeter'
          out  = f"{plain}\n\nFollow daily on Telegram: {link}"
          pathlib.Path('world_en/astro_fb_msg.txt').write_text(out, 'utf-8')
          print('FB text length:', len(out))
          PY

      - name: Post to Facebook Page
        if: ${{ (github.event_name == 'schedule'
            || github.event.inputs.publish_to == 'both'
            || github.event.inputs.publish_to == 'facebook')
            && env.FB_PAGE_ID != '' && env.FB_PAGE_TOKEN != '' }}
        run: |
          set -euo pipefail

          IMG_PATH="$(python - <<'PY'
          import json, os, pathlib
          p = pathlib.Path('world_en/astro.json')
          try:
              data = json.loads(p.read_text('utf-8'))
              cand = data.get('ASTRO_IMAGE_PATH') or data.get('ASTRO_IMAGE_PATH_REL') or ''
              if cand and os.path.exists(cand):
                  print(cand, end='')
          except Exception:
              pass
          PY
          )"

          echo "Facebook IMG_PATH='${IMG_PATH}'"

          MSG="$(cat world_en/astro_fb_msg.txt)"

          if [ -n "${IMG_PATH:-}" ] && [ -f "$IMG_PATH" ]; then
            echo "Facebook: sending photo with caption, image=${IMG_PATH}"
            curl -sS -f -X POST "https://graph.facebook.com/v19.0/${FB_PAGE_ID}/photos" \
              -F "access_token=${FB_PAGE_TOKEN}" \
              -F "caption=${MSG}" \
              -F "source=@${IMG_PATH}" \
              > world_en/fb_astro_response.json
          else
            echo "Facebook: no image found, sending text-only post"
            curl -sS -f -X POST "https://graph.facebook.com/v19.0/${FB_PAGE_ID}/feed" \
              --data-urlencode "message=${MSG}" \
              --data-urlencode "access_token=${FB_PAGE_TOKEN}" \
              > world_en/fb_astro_response.json
          fi

          echo "Facebook response:"; cat world_en/fb_astro_response.json
          grep -q '"id":' world_en/fb_astro_response.json || { echo "Facebook post failed"; exit 1; }

      # ===================== TELEGRAM (TEST) =====================
      - name: Send to TEST Telegram
        if: ${{ github.event_name == 'workflow_dispatch'
            && (github.event.inputs.publish_to == 'test'
            || github.event.inputs.send_to_test == 'true') }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN_TEST }}
          TG_CHAT:  ${{ secrets.CHANNEL_ID_TEST || secrets.TELEGRAM_CHAT_ID_TEST }}
        run: |
          set -euo pipefail
          test -n "${TG_TOKEN}" || { echo "ERROR: TG_TOKEN is empty"; exit 1; }
          test -n "${TG_CHAT}"  || { echo "ERROR: TG_CHAT is empty"; exit 1; }

          IMG_PATH="$(python - <<'PY'
          import json, os, pathlib
          p = 'world_en/astro.json'
          try:
              data = json.loads(pathlib.Path(p).read_text('utf-8'))
              cand = data.get('ASTRO_IMAGE_PATH') or data.get('ASTRO_IMAGE_PATH_REL') or ''
              if cand and os.path.exists(cand):
                  print(cand, end='')
          except Exception:
              pass
          PY
          )"

          echo "Telegram TEST IMG_PATH='${IMG_PATH}'"

          if [ -n "${IMG_PATH:-}" ] && [ -f "$IMG_PATH" ]; then
            echo "Sending sendPhoto with: $IMG_PATH"
            CAPTION="$(python - <<'PY'
          import pathlib
          t = pathlib.Path('world_en/astro_msg.txt').read_text('utf-8', errors='ignore')
          print(t[:1000], end='')
          PY
            )"
            curl -sS -f -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendPhoto" \
              -F "chat_id=${TG_CHAT}" \
              -F "photo=@${IMG_PATH}" \
              -F "caption=${CAPTION}" \
              -F "parse_mode=HTML" \
            | sed 's/\\u[0-9a-fA-F]\{4\}//g'
          else
            echo "No image found — sending text"
            curl -sS -f -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
              -d chat_id="${TG_CHAT}" -d parse_mode="HTML" \
              --data-urlencode text@"world_en/astro_msg.txt"
          fi
