name: Daily VayboMeter (Cyprus)

on:
  schedule:
    # 14:00 UTC â†’ 19:00 Asia/Nicosia
    - cron: '0 14 * * *'
  workflow_dispatch:
    inputs:
      to_test:
        description: "ÐŸÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ñ‚ÑŒ Ð² Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ ÐºÐ°Ð½Ð°Ð»?"
        type: boolean
        default: true
        required: false
      channel_override:
        description: "Ð¯Ð²Ð½Ñ‹Ð¹ chat_id ÐºÐ°Ð½Ð°Ð»Ð° (Ð¿ÐµÑ€ÐµÐ±Ð¸Ð²Ð°ÐµÑ‚ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð²Ñ‹ÑˆÐµ)"
        type: string
        required: false

jobs:
  post:
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Nicosia
      OPENAI_API_KEY:  ${{ secrets.OPENAI_API_KEY }}
      TELEGRAM_TOKEN:  ${{ secrets.TELEGRAM_TOKEN }}
      CHANNEL_ID:      ${{ secrets.CHANNEL_ID }}
      CHANNEL_ID_TEST: ${{ secrets.CHANNEL_ID_TEST }}

    steps:
      - name: ðŸ“¥ Checkout repo
        uses: actions/checkout@v4

      - name: ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÑ‚Ð¸ Schumann Ð¸ Open-Meteo
        run: |
          echo "=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Schumann API Ñ‡ÐµÑ€ÐµÐ· Ð·ÐµÑ€ÐºÐ°Ð»Ð° ==="
          curl -I https://api.codetabs.com/v1/proxy?quest=https://api.glcoherence.org/v1/earth || true
          curl -I https://thingproxy.freeboard.io/fetch/https://api.glcoherence.org/v1/earth || true
          curl -I "https://api.allorigins.win/raw?url=https://api.glcoherence.org/v1/earth" || true
          curl -I https://api.glcoherence.org/v1/earth || true
          curl -I https://gci-api.ucsd.edu/data/latest || true
          echo "---"
          echo "=== ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Open-Meteo Forecast ==="
          curl -I "https://api.open-meteo.com/v1/forecast?latitude=34.707&longitude=33.022&hourly=soil_temperature_0cm" || true

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt requests python-dateutil pendulum astropy

      - name: Export dispatch flags
        if: ${{ github.event_name == 'workflow_dispatch' }}
        shell: bash
        run: |
          echo "TO_TEST=${{ inputs.to_test && '1' || '' }}" >> $GITHUB_ENV
          echo "CHANNEL_ID_OVERRIDE=${{ inputs.channel_override }}" >> $GITHUB_ENV

      - name: ðŸš€ Run VayÐ±Ð¾ÐœÐµÑ‚Ñ€ poster
        shell: bash
        run: |
          args=()
          if [[ -n "${CHANNEL_ID_OVERRIDE}" ]]; then
            args+=(--chat-id "${CHANNEL_ID_OVERRIDE}")
          elif [[ "${TO_TEST}" == "1" ]]; then
            args+=(--to-test)
          fi
          echo "Running: python post.py ${args[*]}"
          python post.py "${args[@]}"
