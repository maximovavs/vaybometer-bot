# .github/workflows/daily_post.yml
name: Daily VayboMeter (Cyprus)

on:
  schedule:
    - cron: "10 3 * * *"
  workflow_dispatch:
    inputs:
      run_evening:
        description: "Запустить вечерний пост"
        type: boolean
        default: true
        required: false
      run_noon_fx:
        description: "Запустить пост только с курсами"
        type: boolean
        default: false
        required: false
      work_date:
        description: "Переопределить дату (YYYY-MM-DD)"
        required: false
        type: string
      to_test:
        description: "Публиковать в тестовый канал?"
        type: boolean
        default: false
        required: false
      channel_override:
        description: "Явный chat_id канала (перебивает параметры выше)"
        required: false
        type: string

permissions:
  contents: read

concurrency:
  group: daily-post-cy
  cancel-in-progress: true

env:
  TELEGRAM_TOKEN:   ${{ secrets.TELEGRAM_TOKEN }}
  CHANNEL_ID:       ${{ secrets.CHANNEL_ID }}
  CHANNEL_ID_TEST:  ${{ secrets.CHANNEL_ID_TEST }}
  OPENAI_API_KEY:   ${{ secrets.OPENAI_API_KEY }}
  GEMINI_API_KEY:   ${{ secrets.GEMINI_API_KEY }}
  GROQ_API_KEY:     ${{ secrets.GROQ_API_KEY }}
  TZ: Asia/Nicosia
  WORK_DATE: ${{ github.event.inputs.work_date }}
  TO_TEST:   ${{ github.event.inputs.to_test }}
  CHANNEL_ID_OVERRIDE: ${{ github.event.inputs.channel_override }}

jobs:
  smoke:
    name: Smoke (syntax only)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Compile only existing *.py (no hardcoded post_common.py)
        shell: bash
        run: |
          set -e
          FILES=()
          for f in post.py *.py scripts/*.py tools/*.py; do
            [ -f "$f" ] && FILES+=("$f")
          done
          if [ ${#FILES[@]} -eq 0 ]; then
            echo "No Python files to compile."
            exit 0
          fi
          echo "Compiling: ${FILES[*]}"
          python -m py_compile "${FILES[@]}"

  daily:
    name: Daily post
    needs: smoke
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_dispatch' &&
       (!github.event.inputs.run_evening || github.event.inputs.run_evening == 'true'))
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install requirements if present
        shell: bash
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; else echo "no requirements.txt"; fi

      - name: Export dispatch flags to env
        if: ${{ github.event_name == 'workflow_dispatch' }}
        shell: bash
        run: |
          echo "RUN_NOON_FX=${{ github.event.inputs.run_noon_fx }}" >> $GITHUB_ENV
          echo "RUN_EVENING=${{ github.event.inputs.run_evening }}" >> $GITHUB_ENV

      - name: Run post.py
        shell: bash
        run: |
          if [ ! -f post.py ]; then
            echo "post.py not found"; exit 0
          fi
          python <<'PY'
          import os, sys, runpy, pendulum

          # Патч today()/now() при ручной дате
          wd = (os.getenv("WORK_DATE") or "").strip()
          if wd:
              tz = pendulum.timezone(os.getenv("TZ","Asia/Nicosia"))
              def _fake(_tz=None):
                  dt = pendulum.parse(wd)
                  return dt.in_tz(_tz or tz)
              pendulum.today = _fake
              pendulum.now   = _fake

          args = ["post.py"]

          # FX-only по запросу из UI (для ручного прогона)
          if (os.getenv("RUN_NOON_FX","").strip().lower() in ("1","true","yes","on")):
              args.append("--fx-only")

          # Канал: override → тест
          chat_override = (os.getenv("CHANNEL_ID_OVERRIDE") or "").strip()
          if chat_override:
              args += ["--chat-id", chat_override]
          else:
              to_test = (os.getenv("TO_TEST","").strip().lower() in ("1","true","yes","on"))
              if to_test:
                  args.append("--to-test")

          print("Running:", " ".join(["python"]+args))
          sys.argv = args
          runpy.run_path("post.py", run_name="__main__")
          PY
