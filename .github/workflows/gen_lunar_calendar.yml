#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
gen_lunar_calendar.py
~~~~~~~~~~~~~~~~~~~~~~
Генерирует файл lunar_calendar.json для текущего месяца.
Каждая запись — это UNIX-метка (00:00 местного времени) дня месяца,
соответствующая информации о лунном дне, фазе, освещённости и астрособытиях.
"""

import json
from pathlib import Path

import pendulum
from lunar import get_day_lunar_info

def main() -> None:
    # Выбираем локальную зону (например, Кипр)
    TZ = pendulum.timezone("Asia/Nicosia")

    # Определяем год и месяц «сегодня»
    today = pendulum.now(TZ)
    year, month = today.year, today.month

    # Узнаём, сколько дней в этом месяце
    first_of_month = pendulum.datetime(year, month, 1, tz=TZ)
    days_in_month = first_of_month.days_in_month

    calendar: dict[str, dict] = {}

    for day in range(1, days_in_month + 1):
        # Для каждого дня создаём datetime в полночь
        dt = pendulum.datetime(year, month, day, 0, 0, 0, tz=TZ)
        # Берём UNIX-метку
        ts = dt.int_timestamp

        # Получаем из lunar.py информацию по этому дню
        info = get_day_lunar_info(dt)

        # Сохраняем в словарь
        calendar[str(ts)] = info

    # Записываем в файл рядом со скриптом
    output_path = Path(__file__).parent / "lunar_calendar.json"
    with open(output_path, "w", encoding="utf-8") as f:
        json.dump(calendar, f, ensure_ascii=False, indent=2)

    print(f"✔ Сгенерирован {output_path.name}: {days_in_month} записей.")

if __name__ == "__main__":
    main()
