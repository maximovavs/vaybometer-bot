name: Collect Schumann

on:
  schedule:
    - cron: "*/30 * * * *"    # каждые 30 минут
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: collect-schumann
  cancel-in-progress: true

env:
  TZ: Asia/Nicosia              # кипрская TZ для меток времени в картинках/коммитах
  # Включите/выключите отправку в TG через Repository variables:
  #   TG_NOTIFY_SCHUMANN = 1 | true | on
  TG_NOTIFY_SCHUMANN: ${{ vars.TG_NOTIFY_SCHUMANN }}

jobs:
  collect:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-

      - name: Install deps
        run: |
          set -e
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          else
            pip install pendulum requests pillow numpy matplotlib
          fi

      # Сбор данных + отрисовка картинок.
      # Если в вашем schumann.py есть ключи/флаги — добавьте их здесь.
      - name: Run collector
        run: |
          set -e
          python schumann.py --save
          # Ожидаемые выходы:
          #   schumann_hourly.json
          #   schumann_amp_48h.png
          #   schumann_amp_7d.png

      - name: Commit & push artifacts
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add schumann_hourly.json schumann_amp_48h.png schumann_amp_7d.png 2>/dev/null || true
          if ! git diff --cached --quiet; then
            git commit -m "schumann: update $(date +'%Y-%m-%d %H:%M %Z')"
            git push
          else
            echo "No changes to commit."
          fi

      - name: Send to Telegram (optional)
        if: ${{ env.TG_NOTIFY_SCHUMANN == '1' || env.TG_NOTIFY_SCHUMANN == 'true' || env.TG_NOTIFY_SCHUMANN == 'on' }}
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHAT_ID:   ${{ secrets.CHANNEL_ID }}
        run: |
          set -e
          CAPTION="Schumann update • $(date +'%Y-%m-%d %H:%M %Z')"
          curl -s -F chat_id="$CHAT_ID" -F caption="$CAPTION (48h)" -F parse_mode="HTML" \
               -F photo="@schumann_amp_48h.png" \
               "https://api.telegram.org/bot$BOT_TOKEN/sendPhoto"
          curl -s -F chat_id="$CHAT_ID" -F caption="$CAPTION (7d)" -F parse_mode="HTML" \
               -F photo="@schumann_amp_7d.png" \
               "https://api.telegram.org/bot$BOT_TOKEN/sendPhoto"
