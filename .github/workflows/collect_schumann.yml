name: Collect Schumann Data

on:
  schedule:
    # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π —á–∞—Å —Ä–æ–≤–Ω–æ
    - cron: '0 * * * *'

jobs:
  schumann:
    runs-on: ubuntu-latest

    steps:
      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: üì• Checkout repo
        uses: actions/checkout@v3

      # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Python 3.11
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏–∑ requirements.txt
      - name: üì¶ Install dependencies
        run: |
          pip install -r requirements.txt

      # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ä–µ–∑–æ–Ω–∞–Ω—Å–∞ –®—É–º–∞–Ω–∞
      - name: üöÄ Fetch Schumann point
        run: |
          python - <<EOF
          import json
          import time
          from pathlib import Path
          from utils import _get

          try:
              # –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Å API
              url = "https://api.glcoherence.org/v1/earth"
              data = _get(url) or {}
              freq = data.get("data", {}).get("sr1", {}).get("frequency_1") or data.get("frequency")
              amp = data.get("data", {}).get("sr1", {}).get("amplitude_1") or data.get("amplitude")
              
              if freq and amp:
                  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ—á–∫—É —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
                  rec = {"ts": int(time.time()), "freq": float(freq), "amp": float(amp)}
                  cache = Path("schumann_hourly.json")
                  arr = json.loads(cache.read_text()) if cache.exists() else []
                  arr.append(rec)
                  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 7 –¥–Ω—è–º–∏ (24 * 7 –∑–∞–ø–∏—Å–µ–π)
                  cutoff = int(time.time()) - 7*24*3600
                  arr = [r for r in arr if r["ts"] >= cutoff]
                  cache.write_text(json.dumps(arr, ensure_ascii=False))
                  print("Saved Schumann point:", rec)
              else:
                  print("No valid freq/amp data received")
          except Exception as e:
              print(f"Error fetching Schumann data: {e}")
          EOF

      # –ö–æ–º–º–∏—Ç–∏–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª –∫—ç—à–∞
      - name: üóÇÔ∏è Commit cache
        uses: stefanzweifel/git-auto-commit-action@v4
        with:
          commit_message: "schumann: add hourly point"
          file_pattern: "schumann_hourly.json"
