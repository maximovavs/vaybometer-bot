name: Monthly VayboMeter Calendar

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  schedule:
    # ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ 10:00 UTC
    - cron: '0 10 * * *'
  workflow_dispatch:
    inputs:
      force_run:
        description: "Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ (ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ Ğ¼ĞµÑÑÑ†)"
        required: false
        default:  "false"

# Ğ´Ğ»Ñ push lunar_calendar.json
permissions:
  contents: write

jobs:
  monthly:
    runs-on: ubuntu-latest

    steps:
    # â”€â”€ 2) Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: true

    # â”€â”€ 3) Ğ ĞµÑˆĞ°ĞµĞ¼: Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ»Ğ¸ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ Ğ¸ ĞºĞ°ĞºĞ¾Ğ¹ Ğ¼ĞµÑÑÑ† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ” Decide month / need-run
      id: decide
      shell: bash
      run: |
        # ĞŸĞ¾-ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾ Ğ½Ğµ Ğ´ĞµĞ»Ğ°ĞµĞ¼
        run=no
        target_month=

        # 3.1 Ğ°Ğ²Ñ‚Ğ¾-Ñ€ĞµĞ¶Ğ¸Ğ¼: ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ° Ğ¿ĞµÑ€Ğ²Ğ¾Ğµ â†’ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ğ¼ Ğ¡Ğ›Ğ•Ğ”Ğ£Ğ®Ğ©Ğ˜Ğ™ Ğ¼ĞµÑÑÑ†
        if [[ $(date -d 'tomorrow' +%d) == "01" ]]; then
          run=yes
          target_month=$(date -d 'tomorrow' +%Y-%m)   # YYYY-MM ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ³Ğ¾
        fi

        # 3.2 Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Ñ force_run=true â†’ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ğ¼ Ğ¢Ğ•ĞšĞ£Ğ©Ğ˜Ğ™ Ğ¼ĞµÑÑÑ†
        if [[ "${{ github.event_name }}" == "workflow_dispatch" && \
              "${{ github.event.inputs.force_run }}" == "true" ]]; then
          run=yes
          target_month=$(date '+%Y-%m')               # Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹
        fi

        echo "run_calendar=$run"     >> $GITHUB_OUTPUT
        echo "target_month=$target_month" >> $GITHUB_OUTPUT
        # ÑĞºÑĞ¿Ğ¾Ñ€Ñ‚ Ğ² env Ğ´Ğ»Ñ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ñ… if:
        echo "RUN_CALENDAR=$run"     >> $GITHUB_ENV
        echo "TARGET_MONTH=$target_month" >> $GITHUB_ENV

    # â”€â”€ 4) Python â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # â”€â”€ 5) Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ (Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¿Ñ€Ğ¸ run=yes) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¦ Install dependencies
      if: env.RUN_CALENDAR == 'yes'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # â”€â”€ 6) Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸŒ™ Generate lunar_calendar.json
      if: env.RUN_CALENDAR == 'yes'
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        python gen_lunar_calendar.py "$TARGET_MONTH"

    # â”€â”€ 7) Commit & push (ĞµÑĞ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»ÑÑ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: âœï¸ Commit & push
      if: env.RUN_CALENDAR == 'yes'
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add lunar_calendar.json
        if git diff --cached --quiet; then
          echo "âœ… lunar_calendar.json ÑƒĞ¶Ğµ Ğ°ĞºÑ‚ÑƒĞ°Ğ»ĞµĞ½."
        else
          git commit -m "chore: update lunar_calendar.json"
          # ĞµÑĞ»Ğ¸ Ğ¿ÑƒÑˆ Ğ½Ğµ Ğ¿Ñ€Ğ¾Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ¸Ğ·-Ğ·Ğ° fast-forward, Ğ¿Ğ¾Ğ´Ñ‚ÑĞ³Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€ÑĞµĞ¼
          if ! git push; then
            git pull --rebase --autostash
            git push
          fi
        fi

    # â”€â”€ 8) ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ° Ğ² Telegram â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¨ Send monthly calendar summary
      if: env.RUN_CALENDAR == 'yes'
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHANNEL_ID:     ${{ secrets.CHANNEL_ID }}
      run: |
        python send_monthly_calendar.py
