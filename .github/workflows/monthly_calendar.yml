name: Monthly VayboMeter Calendar

# â”€â”€â”€ Ñ‚Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  schedule:
    - cron: '0 1 * * *'            # ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾ Ğ² 01:00 UTC â†’ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ² Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ
  workflow_dispatch:               # Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº

# â”€â”€â”€ Ğ½Ğµ Ğ¿Ğ¾Ğ·Ğ²Ğ¾Ğ»ÑĞµĞ¼ Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ¸ ÑÑ‚Ğ¾Ğ³Ğ¾ workflow Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ¹ Ğ²ĞµÑ‚ĞºĞµ â”€â”€â”€â”€â”€
concurrency:
  group: monthly-calendar-${{ github.ref }}
  cancel-in-progress: false        # Ğ¿ÑƒÑÑ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğ¹ run Ğ´Ğ¾Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚

# â”€â”€â”€ Ñ€ĞµĞ¿Ğ¾-Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
permissions:
  contents: write

jobs:
  monthly:
    runs-on: ubuntu-latest

    steps:
      # â”€â”€ step 1: checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true      # Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¼Ñ‹ Ğ¼Ğ¾Ğ³Ğ»Ğ¸ Ğ¿ÑƒÑˆĞ¸Ñ‚ÑŒ
          fetch-depth: 0                 # Ğ½ÑƒĞ¶ĞµĞ½ Ğ¿Ğ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ»Ğ¾Ğ³ Ğ´Ğ»Ñ rebase

      # â”€â”€ step 2: Ğ²Ñ‹Ñ…Ğ¾Ğ´Ğ¸Ğ¼, ĞµÑĞ»Ğ¸ ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ Ğ½Ğµ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ¼ĞµÑÑÑ†Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â© Skip if not last day
        id: skip
        run: |
          tomorrow=$(date -d 'tomorrow' '+%d')
          if [[ "$tomorrow" != "01" ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Not the last day of month â€“ skippingâ€¦" ; exit 0
          fi

      # â”€â”€ step 3: Python + deps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with: { python-version: '3.11' }

      - name: ğŸ“¦ Install dependencies
        if: steps.skip.outputs.skip != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # â”€â”€ step 4: ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ lunar_calendar.json â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸŒ™ Generate lunar_calendar.json
        if: steps.skip.outputs.skip != 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python gen_lunar_calendar.py

      # â”€â”€ step 5: commit + Ğ·Ğ°Ñ‰Ğ¸Ñ‰Ñ‘Ğ½Ğ½Ñ‹Ğ¹ push Ñ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ°Ğ¼Ğ¸ reb ase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: âœï¸ Commit & push calendar (robust)
        if: steps.skip.outputs.skip != 'true'
        env:
          GIT_AUTHOR_NAME:  github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME:  github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          set -eo pipefail
          git add lunar_calendar.json
          # nothing staged?
          git diff --cached --quiet && { echo "âœ” Nothing to commit"; exit 0; }

          git commit -m "chore: update lunar_calendar.json"

          tries=0
          until git pull --rebase --stat origin main && git push origin HEAD:main; do
              ((tries++))
              if [[ $tries -ge 3 ]]; then
                  echo "âŒ Failed to push after 3 attempts"; exit 1
              fi
              echo "âš ï¸  Push race detected â€“ retrying ($tries/3)â€¦"
              sleep 5
          done
          echo "âœ… calendar pushed successfully"

      # â”€â”€ step 6: Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¼ĞµÑÑÑ‡Ğ½Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ğ² ĞºĞ°Ğ½Ğ°Ğ» â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¨ Send monthly calendar summary
        if: steps.skip.outputs.skip != 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHANNEL_ID:     ${{ secrets.CHANNEL_ID }}
        run: python send_monthly_calendar.py
