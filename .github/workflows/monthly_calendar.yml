name: Monthly VayboMeter Calendar

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  schedule:
    - cron: '0 10 * * *'     # ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ² 10:00 UTC
  workflow_dispatch:
    inputs:
      force_run:
        description: "ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Â«Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒÂ» Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑÑ‘"
        required: false
        default: "false"

permissions:
  contents: write            # Ğ½ÑƒĞ¶ĞµĞ½, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿ÑƒÑˆĞ¸Ñ‚ÑŒ JSON

jobs:
  monthly:
    runs-on: ubuntu-latest

    steps:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Â«Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ?Â» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ—“ï¸ Check last day of month
      id: last
      run: |
        if [[ $(date -d 'tomorrow' +%d) == "01" ]]; then
          echo "is_last=true"  >> "$GITHUB_OUTPUT"
        else
          echo "is_last=false" >> "$GITHUB_OUTPUT"
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3b. Override Ñ„Ğ»Ğ°Ğ³Ğ°, ĞµÑĞ»Ğ¸ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑˆĞµĞ½Ğ¾ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: â­ï¸ Override last-day check (manual trigger)
      if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.force_run == 'true' }}
      env:
        GITHUB_OUTPUT: ${{ steps.last.outputs.is_last }}   # Ğ¿Ñ€Ğ¾ĞºĞ¸Ğ½ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½ÑƒÑ
      run:  echo "is_last=true" >> "$GITHUB_OUTPUT"

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. Setup Python (Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾, Ğ²ÑĞµĞ³Ğ´Ğ°) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. Install deps, ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶ĞµĞ½ Ñ€Ğ°ÑÑ‡Ñ‘Ñ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¦ Install dependencies
      if:   steps.last.outputs.is_last == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ ĞºĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸŒ™ Generate lunar_calendar.json
      if:   steps.last.outputs.is_last == 'true'
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run:  python gen_lunar_calendar.py

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7. Commit & push â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: âœï¸ Commit & push calendar
      if:   steps.last.outputs.is_last == 'true'
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add lunar_calendar.json
        if git diff --cached --quiet; then
          echo "âœ… lunar_calendar.json up-to-date"
        else
          git commit -m "chore: update lunar_calendar.json"
          git pull --rebase --autostash || true
          git push
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 8. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ² Telegram â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¨ Send monthly summary
      if:   steps.last.outputs.is_last == 'true'
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHANNEL_ID:     ${{ secrets.CHANNEL_ID }}
      run: python send_monthly_calendar.py
