name: Monthly VayboMeter Calendar

on:
  schedule:
    - cron: '0 10 * * *'     # ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ð¾ 10:00 UTC
  workflow_dispatch:
    inputs:
      force_run:
        description: "Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð½ÐµÐ·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ Ð¾Ñ‚ Ð´Ð°Ñ‚Ñ‹"
        default: "false"
        required: false
      to_test:
        description: "ÐŸÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ñ‚ÑŒ Ð² Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ ÐºÐ°Ð½Ð°Ð»?"
        type: boolean
        default: false
        required: false
      channel_override:
        description: "Ð¯Ð²Ð½Ñ‹Ð¹ chat_id ÐºÐ°Ð½Ð°Ð»Ð° (Ð¿ÐµÑ€ÐµÐ±Ð¸Ð²Ð°ÐµÑ‚ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ Ð²Ñ‹ÑˆÐµ)"
        type: string
        required: false

permissions:
  contents: write

env:
  TZ: Asia/Nicosia

concurrency:
  group: monthly-calendar-${{ github.ref }}
  cancel-in-progress: false

jobs:
  monthly_calendar:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ›Žï¸ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ“… Decide if we should run today
        id: gate
        env:
          FORCE: ${{ github.event.inputs.force_run }}
        run: |
          D=$(date +%d)       # ÑƒÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ TZ Ð¸Ð· env
          if [[ "$FORCE" == "true" || "$D" == "01" ]]; then
            echo "RUN_CALENDAR=yes" >> $GITHUB_ENV
            echo "â„¹ï¸ Calendar run: YES"
          else
            echo "RUN_CALENDAR=no"  >> $GITHUB_ENV
            echo "â„¹ï¸ Calendar run: NO"
          fi

      - name: ðŸ“… Export dispatch flags
        if: env.RUN_CALENDAR == 'yes' && github.event_name == 'workflow_dispatch'
        run: |
          echo "TO_TEST=${{ inputs.to_test && '1' || '' }}" >> $GITHUB_ENV
          echo "CHANNEL_ID_OVERRIDE=${{ inputs.channel_override }}" >> $GITHUB_ENV

      - name: ðŸŒ™ Generate lunar_calendar.json
        if: env.RUN_CALENDAR == 'yes'
        run: python gen_lunar_calendar.py

      - name: ðŸ’¾ Commit updates (if any)
        if: env.RUN_CALENDAR == 'yes'
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add lunar_calendar.json
          if git diff --cached --quiet; then
            echo "âœ… lunar_calendar.json Ð°ÐºÑ‚ÑƒÐ°Ð»ÐµÐ½"
          else
            git commit -m "chore: update lunar_calendar.json"
            git pull --rebase --autostash || true
            git push
          fi

      - name: ðŸ“¨ Send monthly summary
        if: env.RUN_CALENDAR == 'yes'
        env:
          TELEGRAM_TOKEN:  ${{ secrets.TELEGRAM_TOKEN }}
          CHANNEL_ID:      ${{ secrets.CHANNEL_ID }}
          CHANNEL_ID_TEST: ${{ secrets.CHANNEL_ID_TEST }}
        shell: bash
        run: |
          CHAT="$CHANNEL_ID"
          if [ -n "${CHANNEL_ID_OVERRIDE:-}" ]; then
            CHAT="$CHANNEL_ID_OVERRIDE"
          elif [ "${TO_TEST:-}" = "1" ]; then
            CHAT="$CHANNEL_ID_TEST"
          fi
          echo "â†’ Sending to chat: $CHAT"
          CHANNEL_ID="$CHAT" python send_monthly_calendar.py
