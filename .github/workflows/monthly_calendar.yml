name: Monthly VayboMeter Calendar

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1. Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  schedule:
    - cron: '0 1 * * *'      # ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾ 01:00 UTC
  workflow_dispatch:
    inputs:
      force_run:
        description: "ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºÑƒ Â«Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒÂ» Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ²ÑÑ‘"
        required: false
        default: "false"

# Ğ ĞµĞ¿Ğ¾-Ñ‚Ğ¾ĞºĞµĞ½ Ğ½ÑƒĞ¶ĞµĞ½ Ğ½Ğ° push
permissions:
  contents: write

jobs:
  monthly:
    runs-on: ubuntu-latest

    steps:

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 2. Checkout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        persist-credentials: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Â«Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğ¹ Ğ´ĞµĞ½ÑŒ?Â» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ—“ï¸ Check last day of month
      id: check_last_day
      run: |
        tomorrow=$(date -d "tomorrow" '+%d')
        if [[ "$tomorrow" == "01" ]]; then
          echo "is_last=true" >> $GITHUB_OUTPUT
        else
          echo "is_last=false" >> $GITHUB_OUTPUT
        fi
        echo "Tomorrow: $tomorrow"

    # Ğ•ÑĞ»Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ñ force_run=true â†’ Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµĞ¼ Ñ„Ğ»Ğ°Ğ³
    - name: â­ï¸ Override last-day check if requested
      if: ${{ github.event_name == 'workflow_dispatch' && inputs.force_run == 'true' }}
      run: echo "is_last=true" >> $GITHUB_OUTPUT
      id: force

    # Ğ£Ğ´Ğ¾Ğ±Ğ½Ğ°Ñ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ-ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğµ
    - name: ğŸ·ï¸ Set run-condition variable
      run: |
        RAW="${{ steps.force.outputs.is_last || steps.check_last_day.outputs.is_last }}"
        echo "RUN_CALENDAR=$RAW" >> $GITHUB_ENV

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 4. Setup Python (Ğ²ÑĞµĞ³Ğ´Ğ°, Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 5. Install deps â† Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¦ Install dependencies
      if: env.RUN_CALENDAR == 'true'
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 6. Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ JSON â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸŒ™ Generate lunar_calendar.json
      if: env.RUN_CALENDAR == 'true'
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        python gen_lunar_calendar.py

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 7. Commit & push (Ñ€Ğ¾Ğ±Ğ°ÑÑ‚Ğ½Ğ¾) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: âœï¸ Commit & push calendar (robust)
      if: env.RUN_CALENDAR == 'true'
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        git add lunar_calendar.json
        if git diff --cached --quiet; then
          echo "âœ… lunar_calendar.json is already up-to-date."
        else
          git commit -m "chore: update lunar_calendar.json"
          # Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Ğ¿ÑƒÑˆ; ĞµÑĞ»Ğ¸ Ğ½ĞµÑƒĞ´Ğ°Ñ‡Ğ° â†’ pull --rebase Ğ¸ Ğ¿ÑƒÑˆ ÑĞ½Ğ¾Ğ²Ğ°
          if ! git push; then
            git pull --rebase
            git push
          fi
        fi

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 8. ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚ Ğ² Telegram â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - name: ğŸ“¨ Send monthly calendar summary
      if: env.RUN_CALENDAR == 'true'
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        CHANNEL_ID:     ${{ secrets.CHANNEL_ID }}
      run: |
        python send_monthly_calendar.py