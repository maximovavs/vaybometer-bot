name: Monthly VayboMeter Calendar

# ─── триггеры ────────────────────────────────────────────────
on:
  schedule:
    - cron: '0 1 * * *'            # ежедневно в 01:00 UTC → выполнится только в последний день
  workflow_dispatch:               # ручной запуск

# ─── не позволяем параллельные запуски этого workflow на одной ветке ─────
concurrency:
  group: monthly-calendar-${{ github.ref }}
  cancel-in-progress: false        # пусть текущий run доработает

# ─── репо-доступы ────────────────────────────────────────────
permissions:
  contents: write

jobs:
  monthly:
    runs-on: ubuntu-latest

    steps:
      # ── step 1: checkout ───────────────────────────────────
      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true      # чтобы мы могли пушить
          fetch-depth: 0                 # нужен полный лог для rebase

      # ── step 2: выходим, если сегодня не последний день месяца ─────────
      - name: ⏩ Skip if not last day
        id: skip
        run: |
          tomorrow=$(date -d 'tomorrow' '+%d')
          if [[ "$tomorrow" != "01" ]]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Not the last day of month – skipping…" ; exit 0
          fi

      # ── step 3: Python + deps ──────────────────────────────
      - name: 🐍 Setup Python
        uses: actions/setup-python@v4
        with: { python-version: '3.11' }

      - name: 📦 Install dependencies
        if: steps.skip.outputs.skip != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # ── step 4: сгенерировать lunar_calendar.json ──────────
      - name: 🌙 Generate lunar_calendar.json
        if: steps.skip.outputs.skip != 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: python gen_lunar_calendar.py

      # ── step 5: commit + защищённый push с попытками reb ase ───────────
      - name: ✏️ Commit & push calendar (robust)
        if: steps.skip.outputs.skip != 'true'
        env:
          GIT_AUTHOR_NAME:  github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
          GIT_COMMITTER_NAME:  github-actions[bot]
          GIT_COMMITTER_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          set -eo pipefail
          git add lunar_calendar.json
          # nothing staged?
          git diff --cached --quiet && { echo "✔ Nothing to commit"; exit 0; }

          git commit -m "chore: update lunar_calendar.json"

          tries=0
          until git pull --rebase --stat origin main && git push origin HEAD:main; do
              ((tries++))
              if [[ $tries -ge 3 ]]; then
                  echo "❌ Failed to push after 3 attempts"; exit 1
              fi
              echo "⚠️  Push race detected – retrying ($tries/3)…"
              sleep 5
          done
          echo "✅ calendar pushed successfully"

      # ── step 6: отправить месячное сообщение в канал ──────
      - name: 📨 Send monthly calendar summary
        if: steps.skip.outputs.skip != 'true'
        env:
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          CHANNEL_ID:     ${{ secrets.CHANNEL_ID }}
        run: python send_monthly_calendar.py
