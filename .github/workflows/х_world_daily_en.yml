name: world-daily-x
on:
  schedule:
    - cron: "15 7 * * *" # 07:15 UTC –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
  workflow_dispatch:
    inputs:
      publish_to:
        description: "–ö—É–¥–∞ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å?"
        type: choice
        required: false
        default: x
        options:
          - x

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: UTC
      PYTHONPATH: ${{ github.workspace }}
      X_API_KEY: ${{ secrets.X_API_KEY || '' }}
      X_API_SECRET: ${{ secrets.X_API_SECRET || '' }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN || '' }}
      X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET || '' }}
      TG_URL: ${{ secrets.TELEGRAM_CHANNEL_URL || 'https://t.me/WorldVibeMeter' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install deps
        run: pip install requests jinja2 pytz astral tweepy
      
      - name: Collect daily
        env:
          YT_API_KEY: ${{ secrets.YT_API_KEY }}
          YT_CHANNEL_ID: ${{ secrets.YT_CHANNEL_ID }}
          YOUTUBE_PLAYLIST_IDS: ${{ secrets.YOUTUBE_PLAYLIST_IDS }}
          FALLBACK_NATURE_LIST: ${{ secrets.FALLBACK_NATURE_LIST }}
        run: |
          set -euo pipefail
          python world_en/world_collect.py
          test -f world_en/daily.json || { echo "ERROR: world_en/daily.json missing"; exit 1; }
      
      - name: Render
        run: python world_en/render.py world_en/templates/daily_en.j2 world_en/daily.json > world_en/message.txt
      
      # ===================== X (TWITTER) - FREE TIER =====================
      
      - name: Test X API Authentication
        if: ${{ (github.event_name == 'schedule' || inputs.publish_to == 'x') && env.X_API_KEY != '' }}
        run: |
          python - <<'PY'
          import tweepy
          import os
          
          try:
              # –ò—Å–ø–æ–ª—å–∑—É–µ–º API v1.1 –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø–ª–∞–Ω–∞
              auth = tweepy.OAuth1UserHandler(
                  consumer_key=os.getenv('X_API_KEY'),
                  consumer_secret=os.getenv('X_API_SECRET'),
                  access_token=os.getenv('X_ACCESS_TOKEN'),
                  access_token_secret=os.getenv('X_ACCESS_SECRET')
              )
              api = tweepy.API(auth)
              me = api.verify_credentials()
              print(f"‚úÖ Authenticated as: @{me.screen_name}")
              print(f"‚úÖ User ID: {me.id}")
          except tweepy.Forbidden as e:
              print("‚ùå 403 Forbidden - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:")
              print("  1. App permissions = 'Read and Write'")
              print("  2. –¢–æ–∫–µ–Ω—ã –ø–µ—Ä–µ—Å–æ–∑–¥–∞–Ω—ã –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è permissions")
              print(f"  Error: {e}")
              exit(1)
          except Exception as e:
              print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
              exit(1)
          PY
      
      - name: Build X-safe message
        if: ${{ (github.event_name == 'schedule' || inputs.publish_to == 'x') && env.X_API_KEY != '' }}
        run: |
          python - <<'PY'
          import re, html, pathlib, os
          
          p = pathlib.Path('world_en/message.txt').read_text('utf-8')
          plain = re.sub(r'<[^>]+>', '', p)
          plain = html.unescape(plain)
          plain = re.sub(r'[ \t]+\n', '\n', plain)
          plain = re.sub(r'\n{3,}', '\n\n', plain).strip()
          
          # X –∏–º–µ–µ—Ç –ª–∏–º–∏—Ç 280 —Å–∏–º–≤–æ–ª–æ–≤
          if len(plain) > 250:
              plain = plain[:250].rsplit(' ', 1)[0] + '‚Ä¶'
          
          link = os.getenv('TG_URL') or 'https://t.me/WorldVibeMeter'
          out = f"{plain}\n\n{link}\n#SchumannResonance #EcologyVibes"
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –ª–∏–º–∏—Ç–∞
          if len(out) > 280:
              # –£–º–µ–Ω—å—à–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç –µ—â–µ –±–æ–ª—å—à–µ
              diff = len(out) - 280
              plain = plain[:-(diff + 10)].rsplit(' ', 1)[0] + '‚Ä¶'
              out = f"{plain}\n\n{link}\n#SchumannResonance #EcologyVibes"
          
          pathlib.Path('world_en/x_message.txt').write_text(out, 'utf-8')
          print(f'‚úÖ X text prepared ({len(out)}/280 chars)')
          PY
      
      - name: Post to X (main message) - API v1.1
        if: ${{ (github.event_name == 'schedule' || inputs.publish_to == 'x') && env.X_API_KEY != '' }}
        run: |
          python - <<'PY'
          import tweepy
          import pathlib
          import os
          
          # API v1.1 –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø–ª–∞–Ω–∞!
          auth = tweepy.OAuth1UserHandler(
              consumer_key=os.getenv('X_API_KEY'),
              consumer_secret=os.getenv('X_API_SECRET'),
              access_token=os.getenv('X_ACCESS_TOKEN'),
              access_token_secret=os.getenv('X_ACCESS_SECRET')
          )
          api = tweepy.API(auth)
          
          text = pathlib.Path('world_en/x_message.txt').read_text('utf-8')
          
          try:
              # –ü–æ—Å—Ç–∏–º —á–µ—Ä–µ–∑ v1.1 API (update_status)
              status = api.update_status(status=text)
              print(f"‚úÖ Posted to X: https://x.com/{status.user.screen_name}/status/{status.id}")
          except tweepy.TweepyException as e:
              print(f"‚ùå Failed to post: {e}")
              exit(1)
          PY
      
      - name: Post to X (Nature card) - API v1.1
        if: ${{ (github.event_name == 'schedule' || inputs.publish_to == 'x') && env.X_API_KEY != '' }}
        run: |
          python - <<'PY'
          import json
          import urllib.request
          import tempfile
          import os
          import tweepy
          
          # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
          with open('world_en/daily.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          nature_url = data.get('NATURE_URL', '')
          nature_thumb = data.get('NATURE_THUMB', '')
          nature_title = data.get('NATURE_TITLE', 'Nature Break')
          nature_snippet = data.get('NATURE_SNIPPET', '60 seconds of calm')
          
          if not nature_url:
              print("‚ö†Ô∏è  No nature URL ‚Äî skipping")
              exit(0)
          
          # –°–æ–∑–¥–∞–µ–º —Ç–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ (–Ω–µ –±–æ–ª–µ–µ 280 —Å–∏–º–≤–æ–ª–æ–≤!)
          caption = f"üåä {nature_title}\n{nature_snippet}\n{nature_url}"
          if len(caption) > 280:
              # –£—Ä–µ–∑–∞–µ–º snippet –µ—Å–ª–∏ –Ω–µ –≤–ª–µ–∑–∞–µ—Ç
              max_snippet = 280 - len(f"üåä {nature_title}\n\n{nature_url}") - 5
              nature_snippet = nature_snippet[:max_snippet] + '‚Ä¶'
              caption = f"üåä {nature_title}\n{nature_snippet}\n{nature_url}"
          
          # API v1.1 –¥–ª—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–≥–æ –ø–ª–∞–Ω–∞
          auth = tweepy.OAuth1UserHandler(
              consumer_key=os.getenv('X_API_KEY'),
              consumer_secret=os.getenv('X_API_SECRET'),
              access_token=os.getenv('X_ACCESS_TOKEN'),
              access_token_secret=os.getenv('X_ACCESS_SECRET')
          )
          api = tweepy.API(auth)
          
          # –ï—Å–ª–∏ –µ—Å—Ç—å thumbnail - –ø–æ—Å—Ç–∏–º —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
          if nature_thumb:
              try:
                  # –°–∫–∞—á–∏–≤–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                  with urllib.request.urlopen(nature_thumb) as response:
                      with tempfile.NamedTemporaryFile(delete=False, suffix='.jpg') as tmp:
                          tmp.write(response.read())
                          tmp_path = tmp.name
                  
                  # –ü–æ—Å—Ç–∏–º —Å –º–µ–¥–∏–∞ —á–µ—Ä–µ–∑ v1.1 API
                  status = api.update_status_with_media(
                      filename=tmp_path,
                      status=caption
                  )
                  
                  # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
                  os.unlink(tmp_path)
                  
                  print(f"‚úÖ Posted nature with image: https://x.com/{status.user.screen_name}/status/{status.id}")
              except Exception as e:
                  print(f"‚ö†Ô∏è  Failed to upload image, posting without: {e}")
                  # –ü–æ—Å—Ç–∏–º –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                  status = api.update_status(status=caption)
                  print(f"‚úÖ Posted nature (no image): https://x.com/{status.user.screen_name}/status/{status.id}")
          else:
              # –ü–æ—Å—Ç–∏–º –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
              status = api.update_status(status=caption)
              print(f"‚úÖ Posted nature: https://x.com/{status.user.screen_name}/status/{status.id}")
          PY
