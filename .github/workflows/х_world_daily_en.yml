name: world-daily-x
on:
  schedule:
    - cron: "15 7 * * *" # 07:15 UTC –∫–∞–∂–¥—ã–π –¥–µ–Ω—å
  workflow_dispatch:
    inputs:
      publish_to:
        description: "–ö—É–¥–∞ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å?"
        type: choice
        required: false
        default: x
        options:
          - x # —Ç–æ–ª—å–∫–æ X
jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: UTC
      PYTHONPATH: ${{ github.workspace }}
      # –ü–æ–¥–Ω–∏–º–∞–µ–º —Å–µ–∫—Ä–µ—Ç—ã –≤ env –¥–ª—è X
      X_API_KEY: ${{ secrets.X_API_KEY || '' }}
      X_API_SECRET: ${{ secrets.X_API_SECRET || '' }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN || '' }}
      X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET || '' }}
      X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN || '' }}
      TG_URL: ${{ secrets.TELEGRAM_CHANNEL_URL || 'https://t.me/WorldVibeMeter' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install deps
        run: pip install requests jinja2 pytz astral tweepy # –î–æ–±–∞–≤–∏–ª–∏ tweepy –¥–ª—è X
      - name: Collect daily
        env:
          YT_API_KEY: ${{ secrets.YT_API_KEY }}
          YT_CHANNEL_ID: ${{ secrets.YT_CHANNEL_ID }}
          YOUTUBE_PLAYLIST_IDS: ${{ secrets.YOUTUBE_PLAYLIST_IDS }}
          FALLBACK_NATURE_LIST: ${{ secrets.FALLBACK_NATURE_LIST }}
        run: |
          set -euo pipefail
          python world_en/world_collect.py
          echo "---- ls world_en ----"; ls -la world_en || true
          test -f world_en/daily.json || { echo "ERROR: world_en/daily.json missing"; exit 1; }
      - name: Render
        run: python world_en/render.py world_en/templates/daily_en.j2 world_en/daily.json > world_en/message.txt
      - name: Ensure daily.json exists
        run: test -f world_en/daily.json || { echo "daily.json missing"; exit 1; }
      - name: Debug env
        if: ${{ (github.event_name == 'schedule' || inputs.publish_to == 'x') }}
        run: |
          set -euo pipefail
          echo "X_API_KEY length: ${#X_API_KEY}"
          echo "X_API_SECRET length: ${#X_API_SECRET}"
          echo "X_ACCESS_TOKEN length: ${#X_ACCESS_TOKEN}"
          echo "X_ACCESS_SECRET length: ${#X_ACCESS_SECRET}"
          echo "X_BEARER_TOKEN length: ${#X_BEARER_TOKEN}"
          if [ -z "$X_API_KEY" ]; then
            echo "X_API_KEY is empty!"
          else
            echo "X_API_KEY is set"
          fi
          # –ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è –¥—Ä—É–≥–∏—Ö
      # ===================== X (TWITTER) =====================
      - name: Build X-safe message
        if: ${{ (github.event_name == 'schedule' || inputs.publish_to == 'x') && env.X_BEARER_TOKEN != '' }}
        run: |
          python - <<'PY'
          import re, html, pathlib, os
          p = pathlib.Path('world_en/message.txt').read_text('utf-8')
          plain = re.sub(r'<[^>]+>', '', p)
          plain = html.unescape(plain)
          plain = re.sub(r'[ \t]+\n', '\n', plain)
          plain = re.sub(r'\n{3,}', '\n\n', plain).strip()
          if len(plain) > 270:
            plain = plain[:270].rsplit(' ',1)[0] + '‚Ä¶'
          link = os.getenv('TG_URL') or 'https://t.me/WorldVibeMeter'
          out = f"{plain}\n\nFrom: {link} #SchumannResonance #EcologyVibes"
          pathlib.Path('world_en/x_message.txt').write_text(out, 'utf-8')
          print('X text length:', len(out))
          PY
      - name: Post to X (main message)
        if: ${{ (github.event_name == 'schedule' || inputs.publish_to == 'x') && env.X_BEARER_TOKEN != '' }}
        run: |
          set -euo pipefail
          python - <<'PY'
          import tweepy, pathlib
          client = tweepy.Client(bearer_token='${X_BEARER_TOKEN}', wait_on_rate_limit=True)
          text = pathlib.Path('world_en/x_message.txt').read_text('utf-8')
          try:
            response = client.create_tweet(text=text)
            print(f"Posted to X: {response.data['id']}")
          except Exception as e:
            print(f"Error posting: {e}")
          PY
      - name: Post to X (Nature card)
        if: ${{ (github.event_name == 'schedule' || inputs.publish_to == 'x') && env.X_BEARER_TOKEN != '' }}
        run: |
          set -euo pipefail
          readarray -t L < <(python - <<'PY'
          import json, urllib.request, tempfile
          d = json.load(open('world_en/daily.json', 'r', encoding='utf-8'))
          thumb_url = d.get('NATURE_THUMB', '')
          if thumb_url:
              with urllib.request.urlopen(thumb_url) as response, tempfile.NamedTemporaryFile(delete=False) as tmp:
                  tmp.write(response.read())
              print(tmp.name)
          print(d.get('NATURE_URL', ''))
          title = d.get('NATURE_TITLE', 'Nature Break')
          snip = d.get('NATURE_SNIPPET', '60 seconds of calm')
          print(f"üåä {title}\n{snip}\nWatch: " + d.get('NATURE_URL', ''))
          PY
          )
          MEDIA_PATH="${L[0]}"; URL="${L[1]}"; CAPTION="${L[*]:2}"
          if [ -n "$MEDIA_PATH" ] && [ -n "$URL" ]; then
            python - <<'PY'
            import tweepy, pathlib
            client = tweepy.Client(bearer_token='${X_BEARER_TOKEN}', wait_on_rate_limit=True)
            try:
              media = client.media_upload(filename='${MEDIA_PATH}')
              response = client.create_tweet(text='${CAPTION}', media_ids=[media.media_id])
              print(f"Posted nature to X: {response.data['id']}")
            except Exception as e:
              print(f"Error posting nature: {e}")
            PY
          elif [ -n "$URL" ]; then
            python - <<'PY'
            import tweepy
            client = tweepy.Client(bearer_token='${X_BEARER_TOKEN}', wait_on_rate_limit=True)
            try:
              response = client.create_tweet(text='${CAPTION}')
              print(f"Posted nature URL to X: {response.data['id']}")
            except Exception as e:
              print(f"Error posting nature URL: {e}")
            PY
          else
            echo "No nature URL/thumb ‚Äî skipping X nature post."
          fi
