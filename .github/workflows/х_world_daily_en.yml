name: world-daily-x
on:
  schedule:
    - cron: "15 7 * * *" # 07:15 UTC ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ
  workflow_dispatch:
    inputs:
      publish_to:
        description: "ÐšÑƒÐ´Ð° Ð¿ÑƒÐ±Ð»Ð¸ÐºÐ¾Ð²Ð°Ñ‚ÑŒ?"
        type: choice
        required: false
        default: x
        options:
          - x # Ñ‚Ð¾Ð»ÑŒÐºÐ¾ X

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: UTC
      PYTHONPATH: ${{ github.workspace }}
      # ÐŸÐ¾Ð´Ð½Ð¸Ð¼Ð°ÐµÐ¼ ÑÐµÐºÑ€ÐµÑ‚Ñ‹ Ð² env Ð´Ð»Ñ X (Ð±ÐµÐ· Bearer Token - Ð¾Ð½ Ð½Ðµ Ð½ÑƒÐ¶ÐµÐ½!)
      X_API_KEY: ${{ secrets.X_API_KEY || '' }}
      X_API_SECRET: ${{ secrets.X_API_SECRET || '' }}
      X_ACCESS_TOKEN: ${{ secrets.X_ACCESS_TOKEN || '' }}
      X_ACCESS_SECRET: ${{ secrets.X_ACCESS_SECRET || '' }}
      TG_URL: ${{ secrets.TELEGRAM_CHANNEL_URL || 'https://t.me/WorldVibeMeter' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      
      - name: Install deps
        run: pip install requests jinja2 pytz astral tweepy
      
      - name: Collect daily
        env:
          YT_API_KEY: ${{ secrets.YT_API_KEY }}
          YT_CHANNEL_ID: ${{ secrets.YT_CHANNEL_ID }}
          YOUTUBE_PLAYLIST_IDS: ${{ secrets.YOUTUBE_PLAYLIST_IDS }}
          FALLBACK_NATURE_LIST: ${{ secrets.FALLBACK_NATURE_LIST }}
        run: |
          set -euo pipefail
          python world_en/world_collect.py
          test -f world_en/daily.json || { echo "ERROR: world_en/daily.json missing"; exit 1; }
      
      - name: Render
        run: python world_en/render.py world_en/templates/daily_en.j2 world_en/daily.json > world_en/message.txt
      
      # ===================== X (TWITTER) =====================
      
      - name: Test X API Authentication
        if: ${{ (github.event_name == 'schedule' || inputs.publish_to == 'x') && env.X_API_KEY != '' }}
        run: |
          python - <<'PY'
          import tweepy
          import os
          
          required = ['X_API_KEY', 'X_API_SECRET', 'X_ACCESS_TOKEN', 'X_ACCESS_SECRET']
          missing = [v for v in required if not os.getenv(v, '').strip()]
          
          if missing:
              print(f"âŒ Missing secrets: {', '.join(missing)}")
              exit(1)
          
          try:
              client = tweepy.Client(
                  consumer_key=os.getenv('X_API_KEY'),
                  consumer_secret=os.getenv('X_API_SECRET'),
                  access_token=os.getenv('X_ACCESS_TOKEN'),
                  access_token_secret=os.getenv('X_ACCESS_SECRET')
              )
              me = client.get_me()
              print(f"âœ… Authenticated as: @{me.data.username}")
          except tweepy.Unauthorized as e:
              print("âŒ 401 Unauthorized - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:")
              print("  1. App permissions = 'Read and Write' Ð² developer.x.com")
              print("  2. Ð¢Ð¾ÐºÐµÐ½Ñ‹ ÐŸÐ•Ð Ð•Ð¡ÐžÐ—Ð”ÐÐÐ« Ð¿Ð¾ÑÐ»Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ permissions")
              print("  3. OAuth 1.0a Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½")
              print(f"  Error: {e}")
              exit(1)
          except Exception as e:
              print(f"âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: {e}")
              exit(1)
          PY
      
      - name: Build X-safe message
        if: ${{ (github.event_name == 'schedule' || inputs.publish_to == 'x') && env.X_API_KEY != '' }}
        run: |
          python - <<'PY'
          import re, html, pathlib, os
          
          p = pathlib.Path('world_en/message.txt').read_text('utf-8')
          plain = re.sub(r'<[^>]+>', '', p)
          plain = html.unescape(plain)
          plain = re.sub(r'[ \t]+\n', '\n', plain)
          plain = re.sub(r'\n{3,}', '\n\n', plain).strip()
          
          if len(plain) > 270:
              plain = plain[:270].rsplit(' ', 1)[0] + 'â€¦'
          
          link = os.getenv('TG_URL') or 'https://t.me/WorldVibeMeter'
          out = f"{plain}\n\nFrom: {link} #SchumannResonance #EcologyVibes"
          
          pathlib.Path('world_en/x_message.txt').write_text(out, 'utf-8')
          print(f'âœ… X text prepared ({len(out)} chars)')
          PY
      
      - name: Post to X (main message)
        if: ${{ (github.event_name == 'schedule' || inputs.publish_to == 'x') && env.X_API_KEY != '' }}
        run: |
          python - <<'PY'
          import tweepy
          import pathlib
          import os
          
          client = tweepy.Client(
              consumer_key=os.getenv('X_API_KEY'),
              consumer_secret=os.getenv('X_API_SECRET'),
              access_token=os.getenv('X_ACCESS_TOKEN'),
              access_token_secret=os.getenv('X_ACCESS_SECRET'),
              wait_on_rate_limit=True
          )
          
          text = pathlib.Path('world_en/x_message.txt').read_text('utf-8')
          response = client.create_tweet(text=text)
          print(f"âœ… Posted to X: https://x.com/i/web/status/{response.data['id']}")
          PY
      
      - name: Post to X (Nature card with media)
        if: ${{ (github.event_name == 'schedule' || inputs.publish_to == 'x') && env.X_API_KEY != '' }}
        run: |
          python - <<'PY'
          import json
          import urllib.request
          import tempfile
          import os
          import tweepy
          
          # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ
          with open('world_en/daily.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          
          nature_url = data.get('NATURE_URL', '')
          nature_thumb = data.get('NATURE_THUMB', '')
          nature_title = data.get('NATURE_TITLE', 'Nature Break')
          nature_snippet = data.get('NATURE_SNIPPET', '60 seconds of calm')
          
          if not nature_url:
              print("âš ï¸  No nature URL â€” skipping")
              exit(0)
          
          # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð¿Ð¾ÑÑ‚Ð°
          caption = f"ðŸŒŠ {nature_title}\n{nature_snippet}\nWatch: {nature_url}"
          
          # OAuth 1.0a Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¼ÐµÐ´Ð¸Ð° (v1.1 API)
          auth = tweepy.OAuth1UserHandler(
              consumer_key=os.getenv('X_API_KEY'),
              consumer_secret=os.getenv('X_API_SECRET'),
              access_token=os.getenv('X_ACCESS_TOKEN'),
              access_token_secret=os.getenv('X_ACCESS_SECRET')
          )
          api_v1 = tweepy.API(auth)
          
          # Client Ð´Ð»Ñ Ð¿Ð¾ÑÑ‚Ð¸Ð½Ð³Ð° (v2 API)
          client = tweepy.Client(
              consumer_key=os.getenv('X_API_KEY'),
              consumer_secret=os.getenv('X_API_SECRET'),
              access_token=os.getenv('X_ACCESS_TOKEN'),
              access_token_secret=os.getenv('X_ACCESS_SECRET'),
              wait_on_rate_limit=True
          )
          
          # Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ thumbnail - Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¸ Ð¿Ð¾ÑÑ‚Ð¸Ð¼ Ñ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸ÐµÐ¼
          if nature_thumb:
              try:
                  # Ð¡ÐºÐ°Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ
                  with urllib.request.urlopen(nature_thumb) as response:
                      with tempfile.NamedTemporaryFile(delete=False, suffix='.jpg') as tmp:
                          tmp.write(response.read())
                          tmp_path = tmp.name
                  
                  # Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¼ÐµÐ´Ð¸Ð° Ñ‡ÐµÑ€ÐµÐ· v1.1 API
                  media = api_v1.media_upload(filename=tmp_path)
                  
                  # ÐŸÐ¾ÑÑ‚Ð¸Ð¼ Ñ Ð¼ÐµÐ´Ð¸Ð° Ñ‡ÐµÑ€ÐµÐ· v2 API
                  response = client.create_tweet(text=caption, media_ids=[media.media_id])
                  
                  # Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð»
                  os.unlink(tmp_path)
                  
                  print(f"âœ… Posted nature with image to X: https://x.com/i/web/status/{response.data['id']}")
              except Exception as e:
                  print(f"âš ï¸  Failed to upload image, posting without: {e}")
                  # ÐŸÐ¾ÑÑ‚Ð¸Ð¼ Ð±ÐµÐ· Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ ÐµÑÐ»Ð¸ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ð»Ð¾ÑÑŒ
                  response = client.create_tweet(text=caption)
                  print(f"âœ… Posted nature (no image) to X: https://x.com/i/web/status/{response.data['id']}")
          else:
              # ÐŸÐ¾ÑÑ‚Ð¸Ð¼ Ð±ÐµÐ· Ð¸Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
              response = client.create_tweet(text=caption)
              print(f"âœ… Posted nature to X: https://x.com/i/web/status/{response.data['id']}")
          PY
