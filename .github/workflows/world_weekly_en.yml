name: world-weekly-en

on:
  schedule:
    - cron: "0 16 * * 0"   # Sun 16:00 UTC
  workflow_dispatch:
    inputs:
      publish_to:
        description: "–ö—É–¥–∞ –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å?"
        type: choice
        required: false
        default: both
        options:
          - both       # –¢–µ–ª–µ–≥—Ä–∞–º + Facebook
          - telegram   # —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω–æ–π –¢–µ–ª–µ–≥—Ä–∞–º
          - facebook   # —Ç–æ–ª—å–∫–æ Facebook-—Å—Ç—Ä–∞–Ω–∏—Ü–∞
          - test       # —Ç–µ—Å—Ç–æ–≤—ã–π –¢–µ–ª–µ–≥—Ä–∞–º
      send_to_test:
        type: boolean
        description: "(deprecated) Send to TEST channel instead of main"
        default: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: UTC
      PYTHONPATH: ${{ github.workspace }}
      # –≤—ã–Ω–µ—Å–µ–º fb-—Å–µ–∫—Ä–µ—Ç—ã –≤ –æ–∫—Ä—É–∂–µ–Ω–∏–µ, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –≤ if:
      FB_PAGE_ID: ${{ secrets.FB_PAGE_ID || '' }}
      FB_PAGE_TOKEN: ${{ secrets.FB_PAGE_TOKEN || '' }}
      TG_URL: ${{ secrets.TELEGRAM_CHANNEL_URL || 'https://t.me/WorldVibeMeter' }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install requests jinja2 pytz astral

      - name: Collect weekly
        env:
          YT_API_KEY:            ${{ secrets.YT_API_KEY }}
          YT_CHANNEL_ID:         ${{ secrets.YT_CHANNEL_ID }}
          YOUTUBE_PLAYLIST_IDS:  ${{ secrets.YOUTUBE_PLAYLIST_IDS }}
          FALLBACK_NATURE_LIST:  ${{ secrets.FALLBACK_NATURE_LIST }}
        run: |
          set -euo pipefail
          python world_en/world_weekly_collect.py
          echo "---- ls world_en"; ls -l world_en || true
          echo "---- head weekly.json"; head -c 600 world_en/weekly.json || true

      - name: Ensure weekly.json exists
        run: test -f world_en/weekly.json || { echo "weekly.json missing"; exit 1; }

      - name: Render message
        run: python world_en/render.py world_en/templates/weekly_en.j2 world_en/weekly.json > world_en/weekly_msg.txt

      # ===================== TELEGRAM (MAIN) =====================
      - name: Send text (MAIN TG)
        if: ${{ github.event_name == 'schedule'
                || inputs.publish_to == 'both'
                || inputs.publish_to == 'telegram'
                || (inputs.publish_to == '' && inputs.send_to_test != true) }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN_EN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID_EN }}
        run: |
          set -euo pipefail
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" -d parse_mode="HTML" \
            --data-urlencode text@"world_en/weekly_msg.txt"

      - name: Send Nature card (MAIN TG)
        if: ${{ github.event_name == 'schedule'
                || inputs.publish_to == 'both'
                || inputs.publish_to == 'telegram'
                || (inputs.publish_to == '' && inputs.send_to_test != true) }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN_EN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID_EN }}
        run: |
          set -euo pipefail
          readarray -t L < <(python - <<'PY'
          import json
          d=json.load(open('world_en/weekly.json',encoding='utf-8'))
          print(d.get('TOP_NATURE_THUMB',''))
          print(d.get('TOP_NATURE_URL',''))
          title=d.get('TOP_NATURE_TITLE','Nature Break')
          snip =d.get('TOP_NATURE_SNIPPET','Short calm from Miss Relax')
          print(f"üåä <b>{title}</b>\n<i>{snip}</i>")
          PY
          )
          THUMB="${L[0]}"; URL="${L[1]}"; CAPTION="${L[*]:2}"
          if [ -n "$THUMB" ] && [ -n "$URL" ]; then
            curl -s "https://api.telegram.org/bot${TG_TOKEN}/sendPhoto" \
              -F chat_id="${TG_CHAT}" \
              -F photo="${THUMB}" \
              -F parse_mode="HTML" \
              -F caption="$CAPTION" \
              -F reply_markup='{"inline_keyboard":[[{"text":"‚ñ∂Ô∏è Watch on YouTube","url":"'"$URL"'"}]]}'
          elif [ -n "$URL" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
              -d chat_id="${TG_CHAT}" \
              -d text="$URL" \
              -d disable_web_page_preview=false
          else
            echo "No weekly TOP_NATURE_URL ‚Äî skipping TG card."
          fi

      # ===================== FACEBOOK =====================
      - name: Build Facebook-safe weekly text
        if: ${{ (github.event_name == 'schedule'
                 || inputs.publish_to == 'both'
                 || inputs.publish_to == 'facebook')
                && env.FB_PAGE_ID != '' && env.FB_PAGE_TOKEN != '' }}
        run: |
          python - <<'PY'
          import re, html, pathlib, os
          p = pathlib.Path('world_en/weekly_msg.txt').read_text('utf-8', errors='ignore')
          plain = re.sub(r'<[^>]+>', '', p)
          plain = html.unescape(plain)
          plain = re.sub(r'[ \t]+\n', '\n', plain)
          plain = re.sub(r'\n{3,}', '\n\n', plain).strip()
          if len(plain) > 2500:
            plain = plain[:2490].rsplit('\n',1)[0] + '\n‚Ä¶'
          link = os.getenv('TG_URL', 'https://t.me/WorldVibeMeter')
          out  = f"{plain}\n\nFollow daily on Telegram: {link}"
          pathlib.Path('world_en/weekly_fb_msg.txt').write_text(out, 'utf-8')
          print('FB text length:', len(out))
          PY

      - name: Post weekly to Facebook Page
        if: ${{ (github.event_name == 'schedule'
                 || inputs.publish_to == 'both'
                 || inputs.publish_to == 'facebook')
                && env.FB_PAGE_ID != '' && env.FB_PAGE_TOKEN != '' }}
        run: |
          set -euo pipefail
          MSG="$(cat world_en/weekly_fb_msg.txt)"
          curl -s -X POST "https://graph.facebook.com/v19.0/${FB_PAGE_ID}/feed" \
            --data-urlencode "message=$MSG" \
            --data-urlencode "access_token=${FB_PAGE_TOKEN}" \
            > world_en/fb_weekly_response.json
          echo "Facebook response:"; cat world_en/fb_weekly_response.json
          grep -q '"id":' world_en/fb_weekly_response.json || { echo "Facebook post failed"; exit 1; }

      - name: Post weekly Nature link to Facebook
        if: ${{ (github.event_name == 'schedule'
                 || inputs.publish_to == 'both'
                 || inputs.publish_to == 'facebook')
                && env.FB_PAGE_ID != '' && env.FB_PAGE_TOKEN != '' }}
        run: |
          set -euo pipefail
          readarray -t L < <(python - <<'PY'
          import json
          d=json.load(open('world_en/weekly.json','r',encoding='utf-8'))
          print(d.get('TOP_NATURE_URL',''))
          title=d.get('TOP_NATURE_TITLE','Nature Break')
          snip=d.get('TOP_NATURE_SNIPPET','Short calm from Miss Relax')
          print(f"üåä {title}\n{snip}")
          PY
          )
          URL="${L[0]}"; CAP="${L[*]:1}"
          if [ -n "$URL" ]; then
            curl -s -X POST "https://graph.facebook.com/v19.0/${FB_PAGE_ID}/feed" \
              --data-urlencode "message=$CAP" \
              --data-urlencode "link=$URL" \
              --data-urlencode "access_token=${FB_PAGE_TOKEN}" \
              > world_en/fb_weekly_nature_response.json
            echo "Facebook nature response:"; cat world_en/fb_weekly_nature_response.json
          else
            echo "No weekly TOP_NATURE_URL ‚Äî skipping FB nature post."
          fi

      # ===================== TELEGRAM (TEST) =====================
      - name: Send text (TEST TG)
        if: ${{ inputs.publish_to == 'test'
                || (inputs.publish_to == '' && inputs.send_to_test == true) }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN_TEST }}
          TG_CHAT:  ${{ secrets.CHANNEL_ID_TEST }}
        run: |
          set -euo pipefail
          if [ -z "${TG_CHAT}" ]; then echo "TEST chat id is empty"; exit 1; fi
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" -d parse_mode="HTML" \
            --data-urlencode text@"world_en/weekly_msg.txt"

      - name: Send Nature card (TEST TG)
        if: ${{ inputs.publish_to == 'test'
                || (inputs.publish_to == '' && inputs.send_to_test == true) }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN_TEST }}
          TG_CHAT:  ${{ secrets.CHANNEL_ID_TEST }}
        run: |
          set -euo pipefail
          readarray -t L < <(python - <<'PY'
          import json
          d=json.load(open('world_en/weekly.json',encoding='utf-8'))
          print(d.get('TOP_NATURE_THUMB',''))
          print(d.get('TOP_NATURE_URL',''))
          title=d.get('TOP_NATURE_TITLE','Nature Break')
          snip =d.get('TOP_NATURE_SNIPPET','Short calm from Miss Relax')
          print(f"üåä <b>{title}</b>\n<i>{snip}</i>")
          PY
          )
          THUMB="${L[0]}"; URL="${L[1]}"; CAPTION="${L[*]:2}"
          if [ -z "${TG_CHAT}" ]; then echo "TEST chat id is empty"; exit 1; fi
          if [ -n "$THUMB" ] && [ -n "$URL" ]; then
            curl -s "https://api.telegram.org/bot${TG_TOKEN}/sendPhoto" \
              -F chat_id="${TG_CHAT}" \
              -F photo="${THUMB}" \
              -F parse_mode="HTML" \
              -F caption="$CAPTION" \
              -F reply_markup='{"inline_keyboard":[[{"text":"‚ñ∂Ô∏è Watch on YouTube","url":"'"$URL"'"}]]}'
          elif [ -n "$URL" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
              -d chat_id="${TG_CHAT}" \
              -d text="$URL" \
              -d disable_web_page_preview=false
          else
            echo "No weekly TOP_NATURE_URL ‚Äî skipping TG test card."
          fi