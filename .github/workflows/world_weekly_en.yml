name: world-weekly-en

on:
  schedule:
    - cron: "0 16 * * 0"     # Sun 16:00 UTC
  workflow_dispatch:
    inputs:
      send_to_test:
        type: boolean
        description: "Send to TEST channel instead of main"
        default: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: UTC
      PYTHONPATH: ${{ github.workspace }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install requests jinja2 pytz astral

      - name: Collect weekly
        env:
          YT_API_KEY:               ${{ secrets.YT_API_KEY }}
          YT_CHANNEL_ID:            ${{ secrets.YT_CHANNEL_ID }}
          YOUTUBE_PLAYLIST_IDS:     ${{ secrets.YOUTUBE_PLAYLIST_IDS }}
          FALLBACK_NATURE_LIST:     ${{ secrets.FALLBACK_NATURE_LIST }}
        run: python world_en/world_weekly_collect.py

      - name: Render
        run: python world_en/render.py world_en/templates/weekly_en.j2 world_en/weekly.json > world_en/weekly_msg.txt

      - name: Ensure weekly.json exists
        run: test -f world_en/weekly.json || { echo "weekly.json missing"; exit 1; }

      # ========= MAIN Telegram =========
      - name: Send text (MAIN TG)
        if: ${{ inputs.send_to_test != true }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN_EN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID_EN }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" -d parse_mode="HTML" \
            --data-urlencode text@"world_en/weekly_msg.txt"

      - name: Send Nature card (MAIN TG)
        if: ${{ inputs.send_to_test != true }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN_EN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID_EN }}
        run: |
          readarray -t L < <(python - <<'PY'
          import json
          d=json.load(open('world_en/weekly.json',encoding='utf-8'))
          print(d.get('TOP_NATURE_THUMB',''))
          print(d.get('TOP_NATURE_URL',''))
          print(f"üåä <b>{d.get('TOP_NATURE_TITLE','Nature Break')}</b>\n<i>{d.get('TOP_NATURE_SNIPPET','Short calm from Miss Relax')}</i>")
          PY
          )
          THUMB="${L[0]}"; URL="${L[1]}"; CAPTION="${L[*]:2}"
          if [ -n "$THUMB" ] && [ -n "$URL" ]; then
            curl -s "https://api.telegram.org/bot${TG_TOKEN}/sendPhoto" \
              -F chat_id="${TG_CHAT}" \
              -F photo="${THUMB}" \
              -F parse_mode="HTML" \
              -F caption="$CAPTION" \
              -F reply_markup='{"inline_keyboard":[[{"text":"‚ñ∂Ô∏è Watch on YouTube","url":"'"$URL"'"}]]}'
          fi

      # ========= Facebook (MAIN) =========
      - name: Build Facebook weekly message (with tag)
        if: ${{ inputs.send_to_test != true }}
        env:
          FB_TAG_PAGE_ID: ${{ secrets.FB_TAG_PAGE_ID }}   # 842249998972347
          TG_URL:         ${{ secrets.TELEGRAM_CHANNEL_URL }}
        run: |
          python - <<'PY'
          import os, re, html, pathlib
          raw = pathlib.Path('world_en/weekly_msg.txt').read_text('utf-8')
          # strip HTML & normalize whitespace
          plain = re.sub(r'<[^>]+>', '', raw)
          plain = html.unescape(plain)
          plain = re.sub(r'[ \t]+\n', '\n', plain)
          plain = re.sub(r'\n{3,}', '\n\n', plain).strip()

          tail = "\n\nFollow daily on Telegram: " + (os.getenv('TG_URL') or 'https://t.me/WorldVibeMeter')

          tag_id = (os.getenv('FB_TAG_PAGE_ID') or '').strip()
          tag_line = f"\n\nFeaturing @[ {tag_id} ]" if tag_id else ""
          out = (plain + tag_line + tail).replace('@[ ', '@[')

          if len(out) > 2500:
            out = out[:2490].rsplit('\n',1)[0] + '\n‚Ä¶'

          pathlib.Path('world_en/weekly_fb_msg.txt').write_text(out, 'utf-8')
          print("FB message chars:", len(out))
          PY

      - name: Post to Facebook Page (weekly + attempt tag)
        if: ${{ inputs.send_to_test != true }}
        env:
          FB_PAGE_ID:     ${{ secrets.FB_PAGE_ID }}
          FB_PAGE_TOKEN:  ${{ secrets.FB_PAGE_TOKEN }}
          FB_TAG_PAGE_ID: ${{ secrets.FB_TAG_PAGE_ID }}
        run: |
          set -euo pipefail
          # –µ—Å–ª–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤ –Ω–µ—Ç ‚Äî —Ç–∏—Ö–æ —Å–∫–∏–ø–∞–µ–º –±–µ–∑ –æ—à–∏–±–∫–∏
          if [ -z "${FB_PAGE_ID:-}" ] || [ -z "${FB_PAGE_TOKEN:-}" ]; then
            echo "FB secrets missing -> skip FB posting"; exit 0
          fi

          MSG="$(cat world_en/weekly_fb_msg.txt)"

          # 1) publish post
          curl -s -X POST "https://graph.facebook.com/v19.0/${FB_PAGE_ID}/feed" \
            --data-urlencode "message=$MSG" \
            --data-urlencode "access_token=${FB_PAGE_TOKEN}" \
            > world_en/fb_weekly_post.json

          echo "FB post response:"; cat world_en/fb_weekly_post.json

          POST_ID="$(python - <<'PY'
          import json; print(json.load(open('world_en/fb_weekly_post.json')).get('id',''))
          PY
          )"

          # 2) try tagging (best effort)
          if [ -n "${POST_ID}" ] && [ -n "${FB_TAG_PAGE_ID:-}" ]; then
            curl -s -X POST "https://graph.facebook.com/v19.0/${POST_ID}/with_tags" \
              -F "tags=[{\"tag_uid\":\"${FB_TAG_PAGE_ID}\"}]" \
              -F "access_token=${FB_PAGE_TOKEN}" \
              > world_en/fb_weekly_tag.json || true
            echo "Tag response:"; cat world_en/fb_weekly_tag.json || true
          else
            echo "Skip tagging (post id or tag id empty)"
          fi

      # ========= TEST Telegram =========
      - name: Send text (TEST TG)
        if: ${{ inputs.send_to_test == true }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN_TEST }}
          TG_CHAT:  ${{ secrets.CHANNEL_ID_TEST }}
        run: |
          if [ -z "${TG_CHAT}" ]; then echo "TEST chat id is empty"; exit 1; fi
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" -d parse_mode="HTML" \
            --data-urlencode text@"world_en/weekly_msg.txt"

      - name: Send Nature card (TEST TG)
        if: ${{ inputs.send_to_test == true }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN_TEST }}
          TG_CHAT:  ${{ secrets.CHANNEL_ID_TEST }}
        run: |
          readarray -t L < <(python - <<'PY'
          import json
          d=json.load(open('world_en/weekly.json',encoding='utf-8'))
          print(d.get('TOP_NATURE_THUMB',''))
          print(d.get('TOP_NATURE_URL',''))
          print(f"üåä <b>{d.get('TOP_NATURE_TITLE','Nature Break')}</b>\n<i>{d.get('TOP_NATURE_SNIPPET','Short calm from Miss Relax')}</i>")
          PY
          )
          THUMB="${L[0]}"; URL="${L[1]}"; CAPTION="${L[*]:2}"
          if [ -z "${TG_CHAT}" ]; then echo "TEST chat id is empty"; exit 1; fi
          if [ -n "$THUMB" ] && [ -n "$URL" ]; then
            curl -s "https://api.telegram.org/bot${TG_TOKEN}/sendPhoto" \
              -F chat_id="${TG_CHAT}" \
              -F photo="${THUMB}" \
              -F parse_mode="HTML" \
              -F caption="$CAPTION" \
              -F reply_markup='{"inline_keyboard":[[{"text":"‚ñ∂Ô∏è Watch on YouTube","url":"'"$URL"'"}]]}'
          fi