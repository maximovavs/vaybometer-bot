name: world-weekly-en

on:
  schedule:
    - cron: "0 16 * * 0"   # Sun 16:00 UTC
  workflow_dispatch:
    inputs:
      send_to_test:
        type: boolean
        description: "Send to TEST channel instead of main"
        default: false

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      TZ: UTC
      PYTHONPATH: ${{ github.workspace }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - run: pip install requests jinja2 pytz astral

      - name: Collect weekly
        env:
          YT_API_KEY: ${{ secrets.YT_API_KEY }}
          YT_CHANNEL_ID: ${{ secrets.YT_CHANNEL_ID }}
          YOUTUBE_PLAYLIST_IDS: ${{ secrets.YOUTUBE_PLAYLIST_IDS }}
          FALLBACK_NATURE_LIST: ${{ secrets.FALLBACK_NATURE_LIST }}
        run: python world_en/world_weekly_collect.py

      - name: Render
        run: python world_en/render.py world_en/templates/weekly_en.j2 world_en/weekly.json > world_en/weekly_msg.txt

      - name: Ensure weekly.json exists
        run: test -f world_en/weekly.json || { echo "weekly.json missing"; exit 1; }

      # ========= MAIN channel =========
      - name: Send text (MAIN)
        if: ${{ inputs.send_to_test != true }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN_EN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID_EN }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" -d parse_mode="HTML" \
            --data-urlencode text@"world_en/weekly_msg.txt"

      - name: Send Nature card (MAIN)
        if: ${{ inputs.send_to_test != true }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN_EN }}
          TG_CHAT:  ${{ secrets.TELEGRAM_CHAT_ID_EN }}
        run: |
          python - <<'PY'
          import json
          d=json.load(open('world_en/weekly.json',encoding='utf-8'))
          print(d.get('TOP_NATURE_THUMB',''))
          print(d.get('TOP_NATURE_URL',''))
          print(f"üåä <b>{d.get('TOP_NATURE_TITLE','Nature Break')}</b>\n<i>{d.get('TOP_NATURE_SNIPPET','Short calm from Miss Relax')}</i>")
          PY
          readarray -t L < <(python - <<'PY'
          import json; d=json.load(open('world_en/weekly.json'))
          print(d.get('TOP_NATURE_THUMB','')); print(d.get('TOP_NATURE_URL',''));
          print(f"üåä <b>{d.get('TOP_NATURE_TITLE','Nature Break')}</b>\n<i>{d.get('TOP_NATURE_SNIPPET','Short calm from Miss Relax')}</i>")
          PY
          )
          THUMB="${L[0]}"; URL="${L[1]}"; CAPTION="${L[*]:2}"
          if [ -n "$THUMB" ] && [ -n "$URL" ]; then
            curl -s "https://api.telegram.org/bot${TG_TOKEN}/sendPhoto" \
              -F chat_id="${TG_CHAT}" \
              -F photo="${THUMB}" \
              -F parse_mode="HTML" \
              -F caption="$CAPTION" \
              -F reply_markup='{"inline_keyboard":[[{"text":"‚ñ∂Ô∏è Watch on YouTube","url":"'"$URL"'"}]]}'
          fi

      # ========= TEST channel =========
      - name: Send text (TEST)
        if: ${{ inputs.send_to_test == true }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN_TEST }}
          TG_CHAT:  ${{ secrets.CHANNEL_ID_TEST }}
        run: |
          if [ -z "${TG_CHAT}" ]; then echo "TEST chat id is empty"; exit 1; fi
          curl -s -X POST "https://api.telegram.org/bot${TG_TOKEN}/sendMessage" \
            -d chat_id="${TG_CHAT}" -d parse_mode="HTML" \
            --data-urlencode text@"world_en/weekly_msg.txt"

      - name: Send Nature card (TEST)
        if: ${{ inputs.send_to_test == true }}
        env:
          TG_TOKEN: ${{ secrets.TELEGRAM_TOKEN_TEST }}
          TG_CHAT:  ${{ secrets.CHANNEL_ID_TEST }}
        run: |
          readarray -t L < <(python - <<'PY'
          import json; d=json.load(open('world_en/weekly.json'))
          print(d.get('TOP_NATURE_THUMB','')); print(d.get('TOP_NATURE_URL',''));
          print(f"üåä <b>{d.get('TOP_NATURE_TITLE','Nature Break')}</b>\n<i>{d.get('TOP_NATURE_SNIPPET','Short calm from Miss Relax')}</i>")
          PY
          )
          THUMB="${L[0]}"; URL="${L[1]}"; CAPTION="${L[*]:2}"
          if [ -z "${TG_CHAT}" ]; then echo "TEST chat id is empty"; exit 1; fi
          if [ -n "$THUMB" ] && [ -n "$URL" ]; then
            curl -s "https://api.telegram.org/bot${TG_TOKEN}/sendPhoto" \
              -F chat_id="${TG_CHAT}" \
              -F photo="${THUMB}" \
              -F parse_mode="HTML" \
              -F caption="$CAPTION" \
              -F reply_markup='{"inline_keyboard":[[{"text":"‚ñ∂Ô∏è Watch on YouTube","url":"'"$URL"'"}]]}'
          fi
