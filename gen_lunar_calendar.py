#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
gen_lunar_calendar.py
~~~~~~~~~~~~~~~~~~~~~
–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ñ–∞–π–ª lunar_calendar.json –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞ —Å —Ç–æ—á–Ω—ã–º–∏ –∞—Å—Ç—Ä–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–º–∏ —Ä–∞—Å—á—ë—Ç–∞–º–∏
–∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º–∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏.

–î–ª—è –∫–∞–∂–¥–æ–π –¥–∞—Ç—ã —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç:
  - phase         : "–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ –≤ –û–≤–Ω–µ (100% –æ—Å–≤–µ—â.)"
  - percent       : 100
  - sign          : "–û–≤–µ–Ω"
  - aspects       : ["‚òåSaturn (+0.4¬∞)", "‚òçMars (‚àí0.2¬∞)", ‚Ä¶]
  - void_of_course: {"start":"2025-06-17T04:12","end":"2025-06-17T13:45"}  (–ø–æ–∫–∞ –∑–∞–≥–ª—É—à–∫–∞)
  - next_event    : "‚Üí –ß–µ—Ä–µ–∑ 2 –¥–Ω. –ù–æ–≤–æ–ª—É–Ω–∏–µ –≤ –ë–ª–∏–∑–Ω–µ—Ü–∞—Ö"
  - advice        : ["–†–∞–±–æ—Ç–∞/—Ñ–∏–Ω–∞–Ω—Å—ã: ‚Ä¶", "–ß—Ç–æ –æ—Ç–ª–æ–∂–∏—Ç—å: ‚Ä¶", "–†–∏—Ç—É–∞–ª –¥–Ω—è: ‚Ä¶"]
  - favorable_days: {"general":[‚Ä¶], "haircut":[‚Ä¶], ‚Ä¶}
  - unfavorable_days: {"general":[‚Ä¶], ‚Ä¶}
"""

import os
import json
import math
import random
from pathlib import Path
from typing import Dict, Any, List, Optional

import pendulum
import swisseph as swe

# ‚îÄ‚îÄ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π GPT-–∫–ª–∏–µ–Ω—Ç ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
try:
    from openai import OpenAI
    OPENAI_KEY = os.getenv("OPENAI_API_KEY")
    gpt = OpenAI(api_key=OPENAI_KEY) if OPENAI_KEY else None
except ImportError:
    gpt = None

# ‚îÄ‚îÄ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–Ω–µ–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
CATEGORIES: Dict[str, Dict[str, List[int]]] = {
    "general":  {"favorable":[1,2,3,4,7,28,29],     "unfavorable":[13,20,23,24,27]},
    "haircut":  {"favorable":[1,2,4,7,9,10,18,19,24,25,31], "unfavorable":[]},
    "travel":   {"favorable":[5,7,14,15],            "unfavorable":[]},
    "shopping": {"favorable":[3,6,9,12,14,17,20,25], "unfavorable":[13,20,23,24,27]},
    "health":   {"favorable":[1,2,3,4,7,28,29],      "unfavorable":[]},
}

# ‚îÄ‚îÄ –ê—Å–ø–µ–∫—Ç—ã –∏ –æ—Ä–±–∏—Å—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ASPECTS = {0:"‚òå", 60:"‚öπ", 90:"‚ñ°", 120:"‚ñ≥", 180:"‚òç"}
ORBIS   = {0:5.0, 60:4.0, 90:3.0, 120:4.0, 180:5.0}

PLANETS = {
    "Sun":     swe.SUN,
    "Mercury": swe.MERCURY,
    "Venus":   swe.VENUS,
    "Mars":    swe.MARS,
    "Jupiter": swe.JUPITER,
    "Saturn":  swe.SATURN,
    "Uranus":  swe.URANUS,
    "Neptune": swe.NEPTUNE,
    "Pluto":   swe.PLUTO,
}

# ‚îÄ‚îÄ –§–æ–ª–±—ç–∫-—Å–æ–≤–µ—Ç—ã –ø–æ —Ñ–∞–∑–∞–º ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
FALLBACK_ADVICE: Dict[str, List[str]] = {
    "–ù–æ–≤–æ–ª—É–Ω–∏–µ": [
        "–†–∞–±–æ—Ç–∞/—Ñ–∏–Ω–∞–Ω—Å—ã: –ó–∞–ø–ª–∞–Ω–∏—Ä—É–π —Ü–µ–ª–∏ –º–µ—Å—è—Ü–∞, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—è—Å—å –∫–∏–ø—Ä—Å–∫–∏–º —Å–æ–ª–Ω—Ü–µ–º üìù‚òÄÔ∏è",
        "–ó–¥–æ—Ä–æ–≤—å–µ: –ù–∞—á–Ω–∏ –¥–µ–Ω—å —Å –≤–æ–¥—ã –∏ –ª–∏–º–æ–Ω–∞ –∏–∑ —Å–∞–¥–æ–≤ –õ–∏–º–∞—Å—Å–æ–ª–∞ üíßüçã",
        "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ: –°–æ–∑–¥–∞–π –º—É–¥–±–æ—Ä–¥ –º–µ—á—Ç—ã, —Å–∏–¥—è –≤ –∫–∞—Ñ–µ –ü–∞—Ñ–æ—Å–∞ üìå",
        "–†–∏—Ç—É–∞–ª: –ú–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞ –æ—á–∏—Å—Ç–∫—É —É–º–∞ –ø–æ–¥ —à—É–º –º–æ—Ä—è –≤ –õ–∞—Ä–Ω–∞–∫–µ üßòüåä",
        "–≠–Ω–µ—Ä–≥–∏—è: –ó–∞–ø–∏—à–∏ –Ω–∞–º–µ—Ä–µ–Ω–∏—è –∏ –ø–æ–ª–æ–∂–∏ –∏—Ö –ø–æ–¥ –æ–ª–∏–≤–∫–æ–≤—É—é –≤–µ—Ç–≤—å üåø",
        "–û—Ç–ª–æ–∂–∏: –ò–º–ø—É–ª—å—Å–∏–≤–Ω—ã–µ —Ç—Ä–∞—Ç—ã ‚Äî –ª—É—á—à–µ –∫—É–ø–∏ —Ö–∞–ª–ª—É–º–∏ –Ω–∞ —Ä—ã–Ω–∫–µ üßÄ",
        "–°–æ—Ü–∏—É–º: –ü–æ–¥–µ–ª–∏—Å—å –ø–ª–∞–Ω–∞–º–∏ —Å –¥—Ä—É–∑—å—è–º–∏ –∑–∞ —Ñ—Ä–∞–ø–ø–µ –≤ –ù–∏–∫–æ—Å–∏–∏ ‚òï",
        "–†–æ—Å—Ç: –ü–æ—Å–∞–¥–∏ —Å—É–∫–∫—É–ª–µ–Ω—Ç ‚Äî —Å–∏–º–≤–æ–ª –Ω–æ–≤—ã—Ö –Ω–∞—á–∏–Ω–∞–Ω–∏–π –Ω–∞ –ö–∏–ø—Ä–µ üå±",
        "–î–µ—Ç–æ–∫—Å: –ß–∞—Å –±–µ–∑ –≥–∞–¥–∂–µ—Ç–æ–≤, –Ω–∞—Å–ª–∞–∂–¥–∞—è—Å—å –∑–∞–∫–∞—Ç–æ–º –≤ –ê–π—è-–ù–∞–ø–µ üåÖ",
        "–ú–æ—Ç–∏–≤–∞—Ü–∏—è: –ß–∏—Ç–∞–π –≤–¥–æ—Ö–Ω–æ–≤–ª—è—é—â—É—é —Ü–∏—Ç–∞—Ç—É, –≥—É–ª—è—è –ø–æ –¢—Ä–æ–æ–¥–æ—Å—É üìñ",
        "–ü–æ–±–µ–¥–∞: –û—Ç–º–µ—Ç—å –ø—Ä–æ—à–ª—ã–µ —É—Å–ø–µ—Ö–∏, –∫–∞–∫ –∫–∏–ø—Ä—Å–∫–∏–π —Ñ–µ—Å—Ç–∏–≤–∞–ª—å –≤–∏–Ω–∞ üèÜüç∑",
        "–î–µ–π—Å—Ç–≤–∏–µ: –ù–∞—á–Ω–∏ —É—Ç—Ä–µ–Ω–Ω—é—é –ø—Ä–∏–≤—ã—á–∫—É ‚Äî –ø—Ä–æ–±–µ–∂–∫–∞ –ø–æ –Ω–∞–±–µ—Ä–µ–∂–Ω–æ–π üèÉ",
    ],
    "–†–∞—Å—Ç—É—â–∏–π —Å–µ—Ä–ø": [
        "–†–∞–±–æ—Ç–∞/—Ñ–∏–Ω–∞–Ω—Å—ã: –°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—è—Å—å —ç–Ω–µ—Ä–≥–∏–µ–π –ö–∏–ø—Ä–∞ üöÄ",
        "–ó–¥–æ—Ä–æ–≤—å–µ: –£—Ç—Ä–µ–Ω–Ω—è—è –π–æ–≥–∞ –Ω–∞ –ø–ª—è–∂–µ –õ–∞—Ä–Ω–∞–∫–∏ –¥–ª—è –∑–∞—Ä—è–¥–∞ üßò‚Äç‚ôÄÔ∏è",
        "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ: –ù–∞–±—Ä–æ—Å–∞–π –∏–¥–µ–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ –≤ —Ç–∞–≤–µ—Ä–Ω–µ —Å –≤–∏–¥–æ–º –Ω–∞ –º–æ—Ä–µ üé®",
        "–†–∏—Ç—É–∞–ª: –î—ã—Ö–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –ø–æ–¥ –æ–ª–∏–≤–∞–º–∏ –≤ –û–º–æ–¥–æ—Å–µ üå¨Ô∏èüå≥",
        "–≠–Ω–µ—Ä–≥–∏—è: –ù–∞—á–Ω–∏ –∏–∑—É—á–∞—Ç—å –Ω–æ–≤—ã–π –Ω–∞–≤—ã–∫, –∫–∞–∫ —Ä–µ–º–µ—Å–ª–∞ –õ–µ—Ñ–∫–∞—Ä—ã üìö",
        "–û—Ç–ª–æ–∂–∏: –°–ø–æ—Ä—ã –∏ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã ‚Äî –ª—É—á—à–µ –ø–µ–π —Å–º—É–∑–∏ –Ω–∞ –∑–∞–∫–∞—Ç–µ ü•§",
        "–°–æ—Ü–∏—É–º: –ü—Ä–æ–≤–µ–¥–∏ –Ω–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥ –≤ –∫–∞—Ñ–µ –õ–∏–º–∞—Å—Å–æ–ª–∞ –∑–∞ —Å—É–≤–ª–æ–π ü§ùüç¢",
        "–†–æ—Å—Ç: –ó–∞–ø–∏—à–∏ —Ç—Ä–∏ —Ü–µ–ª–∏ –Ω–∞ –Ω–µ–¥–µ–ª—é –∏ —Å–ª–µ–¥—É–π –∏–º —Å –∫–∏–ø—Ä—Å–∫–∏–º —É–ø–æ—Ä—Å—Ç–≤–æ–º ‚úÖ",
        "–î–µ—Ç–æ–∫—Å: –û—á–∏—Å—Ç–∏ —Ä–∞–±–æ—á–µ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –∫–∞–∫ –∫–∏–ø—Ä—Å–∫–∏–µ –≤–∏–Ω–æ–¥–µ–ª—ã –±–æ—á–∫–∏ üßπ",
        "–ú–æ—Ç–∏–≤–∞—Ü–∏—è: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Å—è –Ω–∞ –º–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å, –≤–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –ü–∞—Ñ–æ—Å–æ–º üéì",
        "–ü–æ–±–µ–¥–∞: –ü—Ä–∞–∑–¥–Ω—É–π –º–∏–∫—Ä–æ–ø–æ–±–µ–¥—ã —Å –±–æ–∫–∞–ª–æ–º –∑–∏–≤–∞–Ω—ã üç∑",
        "–î–µ–π—Å—Ç–≤–∏–µ: –û–±–Ω–æ–≤–∏ —Ä–µ–∑—é–º–µ, –∫–∞–∫ –∫–∏–ø—Ä—Å–∫–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –æ–±–Ω–æ–≤–ª—è—é—Ç –∫—Ä—É–∂–µ–≤–æ üìà",
    ],
    "–ü–µ—Ä–≤–∞—è —á–µ—Ç–≤–µ—Ä—Ç—å": [
        "–†–∞–±–æ—Ç–∞/—Ñ–∏–Ω–∞–Ω—Å—ã: –°—Ñ–æ–∫—É—Å–∏—Ä—É–π—Å—è –Ω–∞ –∫–ª—é—á–µ–≤—ã—Ö –∑–∞–¥–∞—á–∞—Ö, –∫–∞–∫ –∫–∏–ø—Ä—Å–∫–∏–π –≤–∏–Ω–æ–¥–µ–ª üçá",
        "–ó–¥–æ—Ä–æ–≤—å–µ: –ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω—ã–π –¥—É—à –¥–ª—è —ç–Ω–µ—Ä–≥–∏–∏, –∫–∞–∫ –≤–æ–ª–Ω—ã –≤ –ê–π—è-–ù–∞–ø–µ ‚ö°",
        "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ: –ü—Ä–æ–≤–µ–¥–∏ –∫—Ä–µ–∞—Ç–∏–≤–Ω—É—é —Å–µ—Å—Å–∏—é –≤ —Ç–µ–Ω–∏ –¢—Ä–æ–æ–¥–æ—Å–∞ üé®",
        "–†–∏—Ç—É–∞–ª: –¢–∞–π–º-–±–ª–æ–∫–∏–Ω–≥ –¥–ª—è –¥–µ–ª, –≤–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Ä—ã–Ω–∫–∞–º–∏ –ù–∏–∫–æ—Å–∏–∏ ‚è≥",
        "–≠–Ω–µ—Ä–≥–∏—è: –ü—Ä–æ–≤–µ—Ä—å –ø—Ä–æ–≥—Ä–µ—Å—Å, –∫–∞–∫ —Ä—ã–±–∞–∫–∏ –õ–∞—Ä–Ω–∞–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç —Å–µ—Ç–∏ üêü",
        "–û—Ç–ª–æ–∂–∏: –ö—Ä—É–ø–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏ ‚Äî –ª—É—á—à–µ –∫—É–ø–∏ –±–∏–ª–µ—Ç –Ω–∞ —Ñ–µ—Å—Ç–∏–≤–∞–ª—å üõë",
        "–°–æ—Ü–∏—É–º: –î–µ–ª–∏—Å—å –∏–¥–µ—è–º–∏ –∑–∞ —É–∂–∏–Ω–æ–º —Å –º–µ–∑–µ –≤ –ü–∞—Ñ–æ—Å–µ üó£Ô∏èüçΩÔ∏è",
        "–†–æ—Å—Ç: –ü—Ä–æ–≤–µ–¥–∏ SWOT-–∞–Ω–∞–ª–∏–∑, –∫–∞–∫ —Å—Ç—Ä–∞—Ç–µ–≥ –Ω–∞ –ö–∏–ø—Ä–µ üìä",
        "–î–µ—Ç–æ–∫—Å: –ë–µ–∑ –≥–∞–¥–∂–µ—Ç–æ–≤ –∑–∞ —É–∂–∏–Ω–æ–º, –∫–∞–∫ –≤ –∫–∏–ø—Ä—Å–∫–∏—Ö —Ç–∞–≤–µ—Ä–Ω–∞—Ö üìµ",
        "–ú–æ—Ç–∏–≤–∞—Ü–∏—è: –ü–æ—Å—Ç–∞–≤—å —á–µ–ª–ª–µ–Ω–¥–∂ –Ω–∞ –Ω–µ–¥–µ–ª—é, –∫–∞–∫ –Ω–∞ –∫–∞—Ä–Ω–∞–≤–∞–ª–µ –õ–∏–º–∞—Å—Å–æ–ª–∞ üéØ",
        "–ü–æ–±–µ–¥–∞: –û—Ç–º–µ—Ç—å —É—Å–ø–µ—Ö–∏, –∫–∞–∫ –Ω–∞ –ø—Ä–∞–∑–¥–Ω–∏–∫–µ –ö–∞—Ç–∞–∫–ª–∏–∑–º–æ—Å üéâ",
        "–î–µ–π—Å—Ç–≤–∏–µ: –ó–∞–ø–ª–∞–Ω–∏—Ä—É–π –≤—Å—Ç—Ä–µ—á—É —Å –∫–æ–º–∞–Ω–¥–æ–π –≤ –¥—É—Ö–µ –∫–∏–ø—Ä—Å–∫–∏—Ö –ø–∞—Ä–∞–¥–æ–≤ üöß",
    ],
    "–†–∞—Å—Ç—É—â–∞—è –õ—É–Ω–∞": [
        "–†–∞–±–æ—Ç–∞/—Ñ–∏–Ω–∞–Ω—Å—ã: –ó–∞–ø—É—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç, –∫–∞–∫ —Ä–µ–≥–∞—Ç–∞ –≤ –õ–∞—Ä–Ω–∞–∫–µ üöÄ‚õµ",
        "–ó–¥–æ—Ä–æ–≤—å–µ: –£—Ç—Ä–µ–Ω–Ω—è—è –∑–∞—Ä—è–¥–∫–∞ –Ω–∞ –ø–ª—è–∂–µ –ü–∞—Ñ–æ—Å–∞ –¥–ª—è –±–æ–¥—Ä–æ—Å—Ç–∏ üèÉ",
        "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ: –†–∏—Å—É–π –∏–ª–∏ –ø–∏—à–∏, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—è—Å—å –∑–∞–∫–∞—Ç–∞–º–∏ –ö–∏–ø—Ä–∞ üé®üåÖ",
        "–†–∏—Ç—É–∞–ª: –ô–æ–≥–∞ –ø–æ–¥ –æ–ª–∏–≤–∞–º–∏ –¥–ª—è —Å–∏–Ω–µ—Ä–≥–∏–∏ —Å –ª—É–Ω–Ω–æ–π —ç–Ω–µ—Ä–≥–∏–µ–π üßò‚Äç‚ôÄÔ∏è",
        "–≠–Ω–µ—Ä–≥–∏—è: –°–æ—Å—Ç–∞–≤—å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã, –∫–∞–∫ –∫–∏–ø—Ä—Å–∫–∏–µ –ø–æ–≤–∞—Ä–∞ –≥–æ—Ç–æ–≤—è—Ç —Å—É–≤–ª—É üîù",
        "–û—Ç–ª–æ–∂–∏: –°—Å–æ—Ä—ã ‚Äî –ª—É—á—à–µ —Ç–∞–Ω—Ü—É–π –Ω–∞ –ø–ª—è–∂–Ω–æ–π –≤–µ—á–µ—Ä–∏–Ω–∫–µ ‚öîÔ∏èüíÉ",
        "–°–æ—Ü–∏—É–º: –ù–µ—Ç–≤–æ—Ä–∫–∏–Ω–≥ –≤ –∫–∞—Ñ–µ –ê–π—è-–ù–∞–ø—ã –∑–∞ —Ñ—Ä–∞–ø–ø–µ ü§ù‚òï",
        "–†–æ—Å—Ç: –û–±–Ω–æ–≤–∏ –ø–æ—Ä—Ç—Ñ–æ–ª–∏–æ, –∫–∞–∫ –º–∞—Å—Ç–µ—Ä–∞ –ö–∏–ø—Ä–∞ —Å–≤–æ–∏ –∏–∑–¥–µ–ª–∏—è üìà",
        "–î–µ—Ç–æ–∫—Å: –ü—Ä–æ–≤–µ–¥–∏ —á–∞—Å –±–µ–∑ —Å–æ—Ü—Å–µ—Ç–µ–π, –∫–∞–∫ –º–æ–Ω–∞—Ö–∏ –≤ –ö–∏–∫–∫–æ—Å–µ üìµ",
        "–ú–æ—Ç–∏–≤–∞—Ü–∏—è: –ß–∏—Ç–∞–π –∫–Ω–∏–≥—É, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—è—Å—å –≤–∏–¥–∞–º–∏ –¢—Ä–æ–æ–¥–æ—Å–∞ üìö",
        "–ü–æ–±–µ–¥–∞: –ü—Ä–∞–∑–¥–Ω—É–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Å –±–æ–∫–∞–ª–æ–º –∫–∏–ø—Ä—Å–∫–æ–≥–æ –≤–∏–Ω–∞ üç∑",
        "–î–µ–π—Å—Ç–≤–∏–µ: –ó–∞–ø—É—Å—Ç–∏ –±–ª–æ–≥ –∏–ª–∏ —Ä–µ–∫–ª–∞–º—É, –∫–∞–∫ —Ñ–µ—Å—Ç–∏–≤–∞–ª—å –≤ –û–º–æ–¥–æ—Å–µ üöÄ",
    ],
    "–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ": [
        "–†–∞–±–æ—Ç–∞/—Ñ–∏–Ω–∞–Ω—Å—ã: –ü—Ä–æ–≤–µ—Ä—å –±—é–¥–∂–µ—Ç, –∫–∞–∫ —Ç–æ—Ä–≥–æ–≤—Ü—ã –Ω–∞ —Ä—ã–Ω–∫–µ –ù–∏–∫–æ—Å–∏–∏ üí∞",
        "–ó–¥–æ—Ä–æ–≤—å–µ: –õ—É–Ω–Ω–∞—è –≤–∞–Ω–Ω–∞ —Å —Å–æ–ª—å—é –∏–∑ –õ–∞—Ä–Ω–∞–∫—Å–∫–æ–≥–æ –æ–∑–µ—Ä–∞ üõÅü¶©",
        "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ: –ü–∏—à–∏ –∏–ª–∏ —Ä–∏—Å—É–π –ø–æ–¥ –∑–≤–µ–∑–¥–∞–º–∏ –ü–∞—Ñ–æ—Å–∞ üåïüé®",
        "–†–∏—Ç—É–∞–ª: –ú–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–µ —É –º–æ—Ä—è –≤ –ê–π—è-–ù–∞–ø–µ üå¨Ô∏è",
        "–≠–Ω–µ—Ä–≥–∏—è: –ó–∞–∫—Ä–æ–π –¥–µ–ª–∞, –∫–∞–∫ –∫–∏–ø—Ä—Å–∫–∏–µ —Ä—ã–±–∞–∫–∏ —Å–µ—Ç–∏ –≤ –∫–æ–Ω—Ü–µ –¥–Ω—è üêü",
        "–û—Ç–ª–æ–∂–∏: –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã ‚Äî –ª—É—á—à–µ –ø–µ–π –∑–∏–≤–∞–Ω—É –≤ —Ç–∞–≤–µ—Ä–Ω–µ üó£Ô∏èüç∑",
        "–°–æ—Ü–∏—É–º: –ù–∞–ø–∏—à–∏ –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å –¥—Ä—É–∑—å—è–º –∑–∞ —É–∂–∏–Ω–æ–º —Å –º–µ–∑–µ üíåüçΩÔ∏è",
        "–†–æ—Å—Ç: –ü—Ä–æ–≤–µ–¥–∏ —Ä–∏—Ç—É–∞–ª –ø—Ä–æ—â–µ–Ω–∏—è, –∫–∞–∫ –Ω–∞ –£—Å–ø–µ–Ω–∏–µ –ë–æ–≥–æ—Ä–æ–¥–∏—Ü—ã üôè",
        "–î–µ—Ç–æ–∫—Å: –ù–æ—á—å –±–µ–∑ –≥–∞–¥–∂–µ—Ç–æ–≤, –∫–∞–∫ –Ω–∞ –∫–∏–ø—Ä—Å–∫–æ–º –∫–∞—Ä–Ω–∞–≤–∞–ª–µ üìµ",
        "–ú–æ—Ç–∏–≤–∞—Ü–∏—è: –°–º–æ—Ç—Ä–∏ –Ω–∞ –õ—É–Ω—É –≤ —Ç–µ–ª–µ—Å–∫–æ–ø, –∫–∞–∫ –≤ –æ–±—Å–µ—Ä–≤–∞—Ç–æ—Ä–∏–∏ –ö–∏–ø—Ä–∞ üî≠",
        "–ü–æ–±–µ–¥–∞: –û—Ç–º–µ—Ç—å —É—Å–ø–µ—Ö–∏, –∫–∞–∫ –Ω–∞ —Ñ–µ—Å—Ç–∏–≤–∞–ª–µ –≤–∏–Ω–∞ –≤ –õ–∏–º–∞—Å—Å–æ–ª–µ üèÜ",
        "–î–µ–π—Å—Ç–≤–∏–µ: –¢–∞–Ω—Ü—É–π –ø–æ–¥ –õ—É–Ω–æ–π, –∫–∞–∫ –Ω–∞ –≤–µ—á–µ—Ä–∏–Ω–∫–µ –≤ –ü–∞—Ñ–æ—Å–µ üíÉ",
    ],
    "–£–±—ã–≤–∞—é—â–∞—è –õ—É–Ω–∞": [
        "–†–∞–±–æ—Ç–∞/—Ñ–∏–Ω–∞–Ω—Å—ã: –ü–æ–¥–≤–µ–¥–∏ –∏—Ç–æ–≥–∏, –∫–∞–∫ –≤–∏–Ω–æ–¥–µ–ª—ã –ö–∏–ø—Ä–∞ –ø–æ—Å–ª–µ —É—Ä–æ–∂–∞—è üîÑ",
        "–ó–¥–æ—Ä–æ–≤—å–µ: –î–µ—Ç–æ–∫—Å-–¥–∏–µ—Ç–∞ —Å –æ–≤–æ—â–∞–º–∏ –∏–∑ —Å–∞–¥–æ–≤ –¢—Ä–æ–æ–¥–æ—Å–∞ ü•£",
        "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ: –ù–∞–ø–∏—à–∏ –ø–∏—Å—å–º–æ –ø—Ä–æ—â–µ–Ω–∏—è —Å–µ–±–µ, –∫–∞–∫ –º–æ–Ω–∞—Ö–∏ –ö–∏–∫–∫–æ—Å–∞ ‚úçÔ∏è",
        "–†–∏—Ç—É–∞–ª: –ô–æ–≥–∞ –Ω–∏–¥—Ä–∞ –Ω–∞ –∑–∞–∫–∞—Ç–µ –≤ –õ–∞—Ä–Ω–∞–∫–µ –¥–ª—è —Ä–µ–ª–∞–∫—Å–∞ üßò‚Äç‚ôÇÔ∏è",
        "–≠–Ω–µ—Ä–≥–∏—è: –û—á–∏—Å—Ç–∏ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, –∫–∞–∫ –∫–∏–ø—Ä—Å–∫–∏–µ —Ç–∞–≤–µ—Ä–Ω—ã –ø–µ—Ä–µ–¥ —Å–µ–∑–æ–Ω–æ–º üßπ",
        "–û—Ç–ª–æ–∂–∏: –õ–∏—à–Ω–∏–µ —Ç—Ä–∞—Ç—ã ‚Äî –ª—É—á—à–µ –∫—É–ø–∏ –æ–ª–∏–≤–∫–æ–≤–æ–µ –º–∞—Å–ª–æ üõëü´í",
        "–°–æ—Ü–∏—É–º: –û—Ç–ø–∏—à–∏—Å—å –æ—Ç –Ω–µ–Ω—É–∂–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫, –∫–∞–∫ –æ—Ç —à—É–º–∞ –ù–∏–∫–æ—Å–∏–∏ üìß",
        "–†–æ—Å—Ç: –í—ã—á–µ—Ä–∫–Ω–∏ –Ω–µ–Ω—É–∂–Ω—ã–µ —Ü–µ–ª–∏, –∫–∞–∫ –Ω–∞ –ö–∞—Ç–∞–∫–ª–∏–∑–º–æ—Å–µ üö´",
        "–î–µ—Ç–æ–∫—Å: –î–µ–Ω—å –º–æ–ª—á–∞–Ω–∏—è, –≤–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–æ–Ω–∞—Å—Ç—ã—Ä—è–º–∏ –ö–∏–ø—Ä–∞ ü§´",
        "–ú–æ—Ç–∏–≤–∞—Ü–∏—è: –ü—Ä–æ–≤–µ–¥–∏ —Ä–∏—Ç—É–∞–ª —Å –æ–≥–Ω–µ–º, –∫–∞–∫ –Ω–∞ –∫–∏–ø—Ä—Å–∫–æ–º –∫–æ—Å—Ç—Ä–µ üî•",
        "–ü–æ–±–µ–¥–∞: –û—Ç–º–µ—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –¥–µ–ª —Å –±–æ–∫–∞–ª–æ–º —Å–∞–Ω–≥—Ä–∏–∏ üçπ",
        "–î–µ–π—Å—Ç–≤–∏–µ: –ó–∞–ø–ª–∞–Ω–∏—Ä—É–π SPA-–¥–µ–Ω—å, –∫–∞–∫ –≤ —Å–ø–∞ –õ–∏–º–∞—Å—Å–æ–ª–∞ üßñ‚Äç‚ôÄÔ∏è",
    ],
    "–ü–æ—Å–ª–µ–¥–Ω—è—è —á–µ—Ç–≤–µ—Ä—Ç—å": [
        "–†–∞–±–æ—Ç–∞/—Ñ–∏–Ω–∞–Ω—Å—ã: –ó–∞–≤–µ—Ä—à–∞–π –¥–µ–ª–∞, –∫–∞–∫ —Ä—ã–±–∞–∫–∏ –ü–∞—Ñ–æ—Å–∞ —Å–µ—Ç–∏ ‚úîÔ∏è",
        "–ó–¥–æ—Ä–æ–≤—å–µ: –¶–∏–≥—É–Ω –Ω–∞ –ø–ª—è–∂–µ –õ–∞—Ä–Ω–∞–∫–∏ –¥–ª—è –≥–∞—Ä–º–æ–Ω–∏–∏ ‚òØÔ∏è",
        "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ: –°–æ—Å—Ç–∞–≤—å –º–∞–Ω–∏—Ñ–µ—Å—Ç –±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç–∏, –∫–∞–∫ –≤ –û–º–æ–¥–æ—Å–µ üôå",
        "–†–∏—Ç—É–∞–ª: –î—ã—Ö–∞—Ç–µ–ª—å–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –ø–æ–¥ –æ–ª–∏–≤–∞–º–∏ –¢—Ä–æ–æ–¥–æ—Å–∞ üå¨Ô∏èüå≥",
        "–≠–Ω–µ—Ä–≥–∏—è: –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —É—Ä–æ–∫–∏ –º–µ—Å—è—Ü–∞, –∫–∞–∫ –Ω–∞ —Ä—ã–Ω–∫–µ –ù–∏–∫–æ—Å–∏–∏ üìù",
        "–û—Ç–ª–æ–∂–∏: –ö—Ä—É–ø–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è ‚Äî –ª—É—á—à–µ –ø–µ–π —Ñ—Ä–∞–ø–ø–µ –≤ –∫–∞—Ñ–µ ‚òï‚è≥",
        "–°–æ—Ü–∏—É–º: –ü–æ–¥–µ–ª–∏—Å—å –≤—ã–≤–æ–¥–∞–º–∏ —Å –¥—Ä—É–∑—å—è–º–∏ –∑–∞ —Å—É–≤–ª–æ–π üç¢üó£Ô∏è",
        "–†–æ—Å—Ç: –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–∏ –ø—Ä–∏–≤—ã—á–∫–∏, –∫–∞–∫ –∫–∏–ø—Ä—Å–∫–∏–µ –º–∞—Å—Ç–µ—Ä–∞ –∫—Ä—É–∂–µ–≤–æ üîç",
        "–î–µ—Ç–æ–∫—Å: –û—á–∏—Å—Ç–∏ —Ü–∏—Ñ—Ä–æ–≤–æ–π –∞—Ä—Ö–∏–≤, –∫–∞–∫ —Ç–∞–≤–µ—Ä–Ω—ã –ø–µ—Ä–µ–¥ —Å–µ–∑–æ–Ω–æ–º üóÇÔ∏è",
        "–ú–æ—Ç–∏–≤–∞—Ü–∏—è: –ß–∏—Ç–∞–π –∫–Ω–∏–≥—É –æ —Ä–∞–∑–≤–∏—Ç–∏–∏, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—è—Å—å –ö–∏–ø—Ä–æ–º üìñ",
        "–ü–æ–±–µ–¥–∞: –û—Ç–º–µ—Ç—å —É—Å–ø–µ—Ö–∏ —Å —É–∂–∏–Ω–æ–º –∏–∑ –º–µ–∑–µ –≤ –ü–∞—Ñ–æ—Å–µ üèÜüçΩÔ∏è",
        "–î–µ–π—Å—Ç–≤–∏–µ: –õ—è–≥ —Å–ø–∞—Ç—å –≤–æ–≤—Ä–µ–º—è, –∫–∞–∫ –ø–æ—Å–ª–µ —Ñ–µ—Å—Ç–∏–≤–∞–ª—è –≤ –õ–∏–º–∞—Å—Å–æ–ª–µ üí§",
    ],
    "–£–±—ã–≤–∞—é—â–∏–π —Å–µ—Ä–ø": [
        "–†–∞–±–æ—Ç–∞/—Ñ–∏–Ω–∞–Ω—Å—ã: –°–≤–µ—Ä—å –ø–ª–∞–Ω—ã, –∫–∞–∫ —Ç–æ—Ä–≥–æ–≤—Ü—ã –Ω–∞ —Ä—ã–Ω–∫–µ –õ–µ—Ñ–∫–∞—Ä—ã üìã",
        "–ó–¥–æ—Ä–æ–≤—å–µ: –õ–µ–≥–∫–∞—è —Ä–∞—Å—Ç—è–∂–∫–∞ –Ω–∞ –ø–ª—è–∂–µ –ê–π—è-–ù–∞–ø—ã –¥–ª—è —Ä–µ–ª–∞–∫—Å–∞ üßò",
        "–¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ: –ù–∞–ø–∏—à–∏ –∏—Ç–æ–≥–∏ —Ü–∏–∫–ª–∞, –≤–¥–æ—Ö–Ω–æ–≤–ª—è—è—Å—å –∑–∞–∫–∞—Ç–∞–º–∏ –ö–∏–ø—Ä–∞ ‚úçÔ∏èüåÖ",
        "–†–∏—Ç—É–∞–ª: –ú–µ–¥–∏—Ç–∞—Ü–∏—è –Ω–∞ –æ—Ç–ø—É—Å–∫–∞–Ω–∏–µ –ø–æ–¥ –∑–≤–µ–∑–¥–∞–º–∏ –ü–∞—Ñ–æ—Å–∞ üå¨Ô∏è",
        "–≠–Ω–µ—Ä–≥–∏—è: –ò–∑–±–∞–≤—å—Å—è –æ—Ç —Ö–ª–∞–º–∞, –∫–∞–∫ –∫–∏–ø—Ä—Å–∫–∏–µ –≤–∏–Ω–æ–¥–µ–ª—ã –æ—Ç —Å—Ç–∞—Ä—ã—Ö –±–æ—á–µ–∫ üßπ",
        "–û—Ç–ª–æ–∂–∏: –ù–æ–≤—ã–µ –Ω–∞—á–∏–Ω–∞–Ω–∏—è ‚Äî –ª—É—á—à–µ –ø–µ–π —á–∞–π —Å —Ç—Ä–∞–≤–∞–º–∏ –∏–∑ –¢—Ä–æ–æ–¥–æ—Å–∞ üåø",
        "–°–æ—Ü–∏—É–º: –ü–æ–±–ª–∞–≥–æ–¥–∞—Ä–∏ –¥—Ä—É–∑–µ–π –∑–∞ –ø–æ–¥–¥–µ—Ä–∂–∫—É –∑–∞ —É–∂–∏–Ω–æ–º —Å —Ö–∞–ª–ª—É–º–∏ üßÄ",
        "–†–æ—Å—Ç: –°–æ—Å—Ç–∞–≤—å –ø–ª–∞–Ω –Ω–∞ –Ω–æ–≤—ã–π —Ü–∏–∫–ª, –∫–∞–∫ –Ω–∞ –∫–∞—Ä–Ω–∞–≤–∞–ª–µ –õ–∏–º–∞—Å—Å–æ–ª–∞ üìÖ",
        "–î–µ—Ç–æ–∫—Å: –ß–∞—Å –±–µ–∑ —Å–æ—Ü—Å–µ—Ç–µ–π, –∫–∞–∫ –º–æ–Ω–∞—Ö–∏ –≤ –º–æ–Ω–∞—Å—Ç—ã—Ä–µ –ö–∏–∫–∫–æ—Å üìµ",
        "–ú–æ—Ç–∏–≤–∞—Ü–∏—è: –ü—Ä–æ–≥—É–ª—è–π—Å—è –ø–æ–¥ –∑–≤–µ–∑–¥–∞–º–∏, –∫–∞–∫ –Ω–∞ –∫–∏–ø—Ä—Å–∫–æ–º –ø–æ–±–µ—Ä–µ–∂—å–µ üö∂‚Äç‚ôÄÔ∏è",
        "–ü–æ–±–µ–¥–∞: –û—Ç–º–µ—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ü–∏–∫–ª–∞ —Å –±–æ–∫–∞–ª–æ–º –∑–∏–≤–∞–Ω—ã üç∑",
        "–î–µ–π—Å—Ç–≤–∏–µ: –ü—Ä–æ–≤–µ–¥–∏ —Ä–∏—Ç—É–∞–ª —Å –≤–æ–¥–æ–π, –∫–∞–∫ –Ω–∞ –ö–∞—Ç–∞–∫–ª–∏–∑–º–æ—Å–µ üåä",
    ],
}

def jd_to_datetime(jd: float) -> pendulum.DateTime:
    """–ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç —é–ª–∏–∞–Ω—Å–∫—É—é –¥–∞—Ç—É UT –≤ pendulum DateTime (UTC)."""
    # JD 2440587.5 —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç Unix epoch
    ts = (jd - 2440587.5) * 86400.0
    return pendulum.from_timestamp(ts, tz="UTC")

def compute_phase_and_sign(jd_ut: float) -> (str, int, str):
    """–í—ã—á–∏—Å–ª—è–µ—Ç —Ñ–∞–∑—É –õ—É–Ω—ã, –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ –∏ –∑–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞."""
    sun_lon  = swe.calc_ut(jd_ut, swe.SUN)[0][0]
    moon_lon = swe.calc_ut(jd_ut, swe.MOON)[0][0]
    angle    = (moon_lon - sun_lon) % 360.0
    illum    = int(round((1 - math.cos(math.radians(angle))) / 2 * 100))

    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∞–∑—ã
    if 0 <= angle < 22.5 or 337.5 <= angle < 360:
        name = "–ù–æ–≤–æ–ª—É–Ω–∏–µ"
    elif 22.5 <= angle < 67.5:
        name = "–†–∞—Å—Ç—É—â–∏–π —Å–µ—Ä–ø"
    elif 67.5 <= angle < 112.5:
        name = "–ü–µ—Ä–≤–∞—è —á–µ—Ç–≤–µ—Ä—Ç—å"
    elif 112.5 <= angle < 157.5:
        name = "–†–∞—Å—Ç—É—â–∞—è –õ—É–Ω–∞"
    elif 157.5 <= angle < 202.5:
        name = "–ü–æ–ª–Ω–æ–ª—É–Ω–∏–µ"
    elif 202.5 <= angle < 247.5:
        name = "–£–±—ã–≤–∞—é—â–∞—è –õ—É–Ω–∞"
    elif 247.5 <= angle < 292.5:
        name = "–ü–æ—Å–ª–µ–¥–Ω—è—è —á–µ—Ç–≤–µ—Ä—Ç—å"
    elif 292.5 <= angle < 337.5:
        name = "–£–±—ã–≤–∞—é—â–∏–π —Å–µ—Ä–ø"

    # –ó–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞ –ø–æ –¥–æ–ª–≥–æ—Ç–µ –õ—É–Ω—ã
    idx   = int(moon_lon // 30) % 12
    signs = ["–û–≤–µ–Ω","–¢–µ–ª–µ—Ü","–ë–ª–∏–∑–Ω–µ—Ü—ã","–†–∞–∫","–õ–µ–≤","–î–µ–≤–∞",
             "–í–µ—Å—ã","–°–∫–æ—Ä–ø–∏–æ–Ω","–°—Ç—Ä–µ–ª–µ—Ü","–ö–æ–∑–µ—Ä–æ–≥","–í–æ–¥–æ–ª–µ–π","–†—ã–±—ã"]
    sign  = signs[idx]

    phase_str = f"{name} –≤ {sign} ({illum}% –æ—Å–≤–µ—â.)"
    return phase_str, illum, sign

def compute_aspects(jd_ut: float) -> List[str]:
    """–ò—â–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∞—Å–ø–µ–∫—Ç—ã –õ—É–Ω—ã –∫ –ø–ª–∞–Ω–µ—Ç–∞–º."""
    moon_lon = swe.calc_ut(jd_ut, swe.MOON)[0][0]
    out: List[str] = []
    for pname, pid in PLANETS.items():
        pl_lon = swe.calc_ut(jd_ut, pid)[0][0]
        diff   = abs((moon_lon - pl_lon + 180) % 360 - 180)
        for ang, sym in ASPECTS.items():
            orb = ORBIS.get(ang, 3.0)
            if abs(diff - ang) <= orb:
                out.append(f"{sym}{pname} ({diff - ang:+.1f}¬∞)")
    return out

def compute_next_event(jd_ut: float) -> str:
    """–ù–∞—Ö–æ–¥–∏—Ç –±–ª–∏–∂–∞–π—à–µ–µ –ø–æ–ª–Ω–æ–ª—É–Ω–∏–µ –∏–ª–∏ –Ω–æ–≤–æ–ª—É–Ω–∏–µ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∞–Ω–æ–Ω—Å."""
    # –±–ª–∏–∂–∞–π—à–µ–µ –Ω–æ–≤–æ–ª—É–Ω–∏–µ
    nm_jd = swe.swe_next_new_moon(jd_ut)
    fm_jd = swe.swe_next_full_moon(jd_ut)
    now_date = pendulum.from_timestamp((jd_ut - 2440587.5)*86400, tz="UTC").date()

    nm_dt = jd_to_datetime(nm_jd).date()
    fm_dt = jd_to_datetime(fm_jd).date()
    dm = (nm_dt - now_date).days
    df = (fm_dt - now_date).days

    if dm <= df:
        days, jd_next = dm, nm_jd
    else:
        days, jd_next = df, fm_jd

    phase_str, _, _ = compute_phase_and_sign(jd_next)
    return f"‚Üí –ß–µ—Ä–µ–∑ {days} –¥–Ω. {phase_str}"

def compute_advice(d: pendulum.Date, phase_str: str) -> List[str]:
    """–ü–æ–ª—É—á–∞–µ—Ç 3 —Å–æ–≤–µ—Ç–∞ —á–µ—Ä–µ–∑ GPT –∏–ª–∏ –∏–∑ —Ñ–æ–ª–±—ç–∫–∞."""
    phase_name = phase_str.split(" –≤ ")[0]
    if gpt:
        prompt = (
            f"–î–µ–π—Å—Ç–≤—É–π –∫–∞–∫ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Ç—Ä–æ–ª–æ–≥, –∫–æ—Ç–æ—Ä—ã–π –¥–∞–µ—Ç –æ—á–µ–Ω—å –∫—Ä—É—Ç—ã–µ –∏ –¥–µ–π—Å—Ç–≤–µ–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ —Å —á—É–≤—Å—Ç–≤–æ–º —Å—Ä–µ–¥–Ω–µ–∑–µ–º–Ω–æ–º–æ—Ä—Å–∫–æ–≥–æ —é–º–æ—Ä–∞: –¥–∞—Ç–∞ {d.to_date_string()}, "
            f"—Ñ–∞–∑–∞ –õ—É–Ω—ã: {phase_str}. "
            "–î–∞–π —Ä–æ–≤–Ω–æ —Ç—Ä–∏ –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–∞, –¥–æ–±–∞–≤–ª—è—è —Å–º–∞–π–ª–∏–∫–∏, –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö:\n"
            "‚Ä¢ —Ä–∞–±–æ—Ç–∞/—Ñ–∏–Ω–∞–Ω—Å—ã\n‚Ä¢ —á—Ç–æ –æ—Ç–ª–æ–∂–∏—Ç—å\n‚Ä¢ —Ä–∏—Ç—É–∞–ª –¥–Ω—è"
        )
        resp = gpt.chat.completions.create(
            model="gpt-4o-mini", temperature=0.7,
            messages=[{"role":"user","content":prompt}]
        )
        lines = [ln.strip() for ln in resp.choices[0].message.content.split("\n") if ln.strip()]
        return lines[:3]
    else:
        return random.sample(FALLBACK_ADVICE.get(phase_name, FALLBACK_ADVICE["–ù–æ–≤–æ–ª—É–Ω–∏–µ"]), k=3)

def generate_calendar(year: int, month: int) -> Dict[str, Any]:
    swe.set_ephe_path('.')  # –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, —É–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ —ç—Ñ–µ–º–µ—Ä–∏–¥–∞–º
    start = pendulum.date(year, month, 1)
    end   = start.end_of('month')
    cal: Dict[str, Any] = {}

    # 1) –±–∞–∑–æ–≤—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è
    d = start
    while d <= end:
        jd_ut = swe.julday(d.year, d.month, d.day, 0.0)
        phase_str, illum, sign = compute_phase_and_sign(jd_ut)
        cal[d.to_date_string()] = {
            "phase":          phase_str,
            "percent":        illum,
            "sign":           sign,
            "aspects":        compute_aspects(jd_ut),
            "void_of_course": {"start": None, "end": None},  # TODO: –≤—ã—á–∏—Å–ª–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π V/C
            "next_event":     compute_next_event(jd_ut),
            "advice":         compute_advice(d, phase_str),
            "favorable_days": {cat: CATEGORIES[cat]["favorable"] for cat in CATEGORIES},
            "unfavorable_days":{cat: CATEGORIES[cat]["unfavorable"] for cat in CATEGORIES},
        }
        d = d.add(days=1)

    return cal

def main():
    today = pendulum.today()
    data  = generate_calendar(today.year, today.month)
    out   = Path(__file__).parent / "lunar_calendar.json"
    out.write_text(json.dumps(data, ensure_ascii=False, indent=2), encoding="utf-8")
    print(f"‚úÖ lunar_calendar.json —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è {today.format('MMMM YYYY')}")

if __name__ == "__main__":
    main()
