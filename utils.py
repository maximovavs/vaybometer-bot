#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
utils.py â€¢ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğµ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ¸, Ğ¾Ñ‚ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ñ… Ğ·Ğ°Ğ²Ğ¸ÑÑÑ‚ Ğ²ÑĞµ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ÑƒĞ»Ğ¸
"""

from __future__ import annotations

import logging
import random
import time
from typing import Any

import pendulum
import requests

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ĞºĞ¾Ğ¼Ğ¿Ğ°Ñ / Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
COMPASS = [
    "N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE",
    "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW",
]


def compass(deg: float) -> str:
    """0â€“360Â° â†’ Ñ€ÑƒĞ¼Ğ±Ğ° ĞºĞ¾Ğ¼Ğ¿Ğ°ÑĞ° (N, NE â€¦)."""
    return COMPASS[int((deg / 22.5) + 0.5) % 16]


def clouds_word(pc: int) -> str:
    if pc < 25:
        return "ÑÑĞ½Ğ¾"
    if pc < 70:
        return "Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ"
    return "Ğ¿Ğ°ÑĞ¼ÑƒÑ€Ğ½Ğ¾"


def wind_phrase(km_h: float) -> str:
    if km_h < 2:
        return "ÑˆÑ‚Ğ¸Ğ»ÑŒ"
    if km_h < 8:
        return "ÑĞ»Ğ°Ğ±Ñ‹Ğ¹"
    if km_h < 14:
        return "ÑƒĞ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹"
    return "ÑĞ¸Ğ»ÑŒĞ½Ñ‹Ğ¹"


def safe(v: Any, unit: str = "") -> str:
    """Ğ§Ğ¸ÑĞ»Ğ¾ â†’ Â«xx.x unitÂ», None/â€” â†’ Â«Ğ½/Ğ´Â»."""
    if v in (None, "None", "â€”", "Ğ½/Ğ´"):
        return "Ğ½/Ğ´"
    return f"{v:.1f}{unit}" if isinstance(v, (int, float)) else f"{v}{unit}"


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AQI / PM Ñ†Ğ²ĞµÑ‚Ğ½Ñ‹Ğµ Ğ¸Ğ½Ğ´Ğ¸ĞºĞ°Ñ‚Ğ¾Ñ€Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def aqi_color(aqi: Any) -> str:
    if aqi in ("Ğ½/Ğ´", None, "â€”"):
        return "âšª"
    aqi = float(aqi)
    if aqi <= 50:
        return "ğŸŸ¢"
    if aqi <= 100:
        return "ğŸŸ¡"
    if aqi <= 150:
        return "ğŸŸ "
    if aqi <= 200:
        return "ğŸ”´"
    if aqi <= 300:
        return "ğŸŸ£"
    return "ğŸŸ¤"


def pm_color(pm_val: Any) -> str:
    """
    Ğ¦Ğ²ĞµÑ‚Ğ¾Ğ²Ğ°Ñ Ğ¼Ğ°Ñ€ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ´Ğ»Ñ PM-Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ĞµĞ»ĞµĞ¹.
    12 â†’ 'ğŸŸ¢12', 35 â†’ 'ğŸŸ¡35' â€¦, Â«Ğ½/Ğ´Â» â†’ 'Ğ½/Ğ´'
    """
    if pm_val in (None, "Ğ½/Ğ´", "â€”"):
        return "Ğ½/Ğ´"
    v = float(pm_val)
    if v <= 15:
        mark = "ğŸŸ¢"
    elif v <= 30:
        mark = "ğŸŸ¡"
    elif v <= 55:
        mark = "ğŸŸ "
    elif v <= 110:
        mark = "ğŸ”´"
    else:
        mark = "ğŸŸ£"
    return f"{mark}{int(round(v))}"


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¤Ğ°ĞºÑ‚Ñ‹ Ğ´Ğ½Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FACTS = {
    "01-01": "1 ÑĞ½Ğ²Ğ°Ñ€Ñ â€” Ğ½Ğ° ĞšĞ¸Ğ¿Ñ€Ğµ ÑƒĞ¶Ğµ Ñ†Ğ²ĞµÑ‚Ñ‘Ñ‚ Ğ¼Ğ¸Ğ½Ğ´Ğ°Ğ»ÑŒ ğŸŒ¸",
    "02-14": "14 Ñ„ĞµĞ²Ñ€Ğ°Ğ»Ñ 1960 â€” Ğ¿Ñ€Ğ¾Ğ²Ğ¾Ğ·Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ° Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞšĞ¸Ğ¿Ñ€ ğŸ‡¨ğŸ‡¾",
    "03-22": "22 Ğ¼Ğ°Ñ€Ñ‚Ğ° â€” Ğ’ÑĞµĞ¼Ğ¸Ñ€Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ²Ğ¾Ğ´Ñ‹ ğŸ’§",
    "04-27": "27 Ğ°Ğ¿Ñ€ĞµĞ»Ñ 1961 â€” Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚ Ğ°ÑÑ€Ğ¾Ğ¿Ğ¾Ñ€Ñ‚ Ğ›Ğ°Ñ€Ğ½Ğ°ĞºĞ¸ âœˆï¸",
    "05-11": "11 Ğ¼Ğ°Ñ â€” Ğ”ĞµĞ½ÑŒ Ğ¼Ğ¾Ñ€ÑĞºĞ¾Ğ³Ğ¾ Ğ±Ñ€Ğ¸Ğ·Ğ° Ğ½Ğ° ĞšĞ¸Ğ¿Ñ€Ğµ ğŸŒ¬ï¸",
    "06-08": "8 Ğ¸ÑĞ½Ñ 2004 â€” Ñ‚Ñ€Ğ°Ğ½Ğ·Ğ¸Ñ‚ Ğ’ĞµĞ½ĞµÑ€Ñ‹ Ğ¿Ğ¾ Ğ´Ğ¸ÑĞºÑƒ Ğ¡Ğ¾Ğ»Ğ½Ñ†Ğ° ğŸŒ",
    "07-20": "20 Ğ¸ÑĞ»Ñ â€” ÑĞ¾Ğ±Ğ¸Ñ€Ğ°ÑÑ‚ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğ¶Ğ°Ğ¹ Ğ²Ğ¸Ğ½Ğ¾Ğ³Ñ€Ğ°Ğ´Ğ° ğŸ‡",
    "08-16": "16 Ğ°Ğ²Ğ³ÑƒÑÑ‚Ğ° â€” ÑĞ°Ğ¼Ñ‹Ğ¹ Ñ‚Ñ‘Ğ¿Ğ»Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ğ³Ğ¾Ğ´Ğ° ğŸ”¥",
    "09-27": "27 ÑĞµĞ½Ñ‚ÑĞ±Ñ€Ñ â€” Ğ’ÑĞµĞ¼Ğ¸Ñ€Ğ½Ñ‹Ğ¹ Ğ´ĞµĞ½ÑŒ Ñ‚ÑƒÑ€Ğ¸Ğ·Ğ¼Ğ° ğŸ§³",
    "10-31": "31 Ğ¾ĞºÑ‚ÑĞ±Ñ€Ñ â€” Ğ¿Ğ¸Ğº Â«Ğ±Ğ°Ñ€Ñ…Ğ°Ñ‚Ğ½Ğ¾Ğ³Ğ¾Â» ÑĞµĞ·Ğ¾Ğ½Ğ° ğŸ–ï¸",
    "12-22": "22 Ğ´ĞµĞºĞ°Ğ±Ñ€Ñ â€” Ñ€Ğ°ÑĞ¿ÑƒÑĞºĞ°ÑÑ‚ÑÑ Ğ·Ğ¸Ğ¼Ğ½Ğ¸Ğµ Ğ°Ğ½ĞµĞ¼Ğ¾Ğ½Ñ‹ ğŸŒº",
}


def get_fact(date_obj: pendulum.Date) -> str:
    return FACTS.get(date_obj.format("MM-DD"),
                     "ĞĞ° ĞšĞ¸Ğ¿Ñ€Ğµ Ğ² Ğ³Ğ¾Ğ´Ñƒ â‰ˆ 340 ÑĞ¾Ğ»Ğ½ĞµÑ‡Ğ½Ñ‹Ñ… Ğ´Ğ½ĞµĞ¹ â˜€ï¸")


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ğ¸ĞºĞ¾Ğ½ĞºĞ¸ / K-index Ñ†Ğ²ĞµÑ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
WEATHER_ICONS = {
    "ÑÑĞ½Ğ¾": "â˜€ï¸",
    "Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ğ°Ñ": "ğŸŒ¤ï¸",
    "Ğ¿Ğ°ÑĞ¼ÑƒÑ€Ğ½Ğ¾": "â˜ï¸",
    "Ğ´Ğ¾Ğ¶Ğ´ÑŒ": "ğŸŒ§ï¸",
    "Ñ‚ÑƒĞ¼Ğ°Ğ½": "ğŸŒ",
}

AIR_EMOJI = {
    "Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¸Ğ¹": "ğŸŸ¢",
    "ÑƒĞ¼ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹": "ğŸŸ¡",
    "Ğ²Ñ€ĞµĞ´Ğ½Ñ‹Ğ¹": "ğŸŸ ",
    "Ğ¾Ñ‡. Ğ²Ñ€ĞµĞ´Ğ½Ñ‹Ğ¹": "ğŸ”´",
    "Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ğ¹": "ğŸŸ£",
    "Ğ½/Ğ´": "âšª",
}

K_COLOR = {"green": range(0, 4), "yellow": range(4, 6), "red": range(6, 10)}


def kp_emoji(kp: float) -> str:
    k = int(round(kp))
    if k in K_COLOR["green"]:
        return "ğŸŸ¢"
    if k in K_COLOR["yellow"]:
        return "ğŸŸ¡"
    return "ğŸ”´"


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Ñ‚Ñ€ĞµĞ½Ğ´ Ğ´Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def pressure_trend(w: dict) -> str:
    """
    Ğ‘ĞµÑ€Ñ‘Ğ¼ Ğ´Ğ²Ğ° Ğ¿ĞµÑ€Ğ²Ñ‹Ñ… Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ hourly['surface_pressure']:
      â€¢ diff â‰¥ 2 Ğ³ĞŸĞ° â†’ â†‘
      â€¢ diff â‰¤ -2 Ğ³ĞŸĞ° â†’ â†“
      â€¢ Ğ¸Ğ½Ğ°Ñ‡Ğµ â†’ â†’.
    """
    hp = w.get("hourly", {}).get("surface_pressure", [])
    if len(hp) < 2:
        return "â†’"
    diff = hp[1] - hp[0]
    if diff >= 2:
        return "â†‘"
    if diff <= -2:
        return "â†“"
    return "â†’"


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ HTTP-Ğ¾Ğ±Ñ‘Ñ€Ñ‚ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _get_retry(url: str, retries: int = 2, **params):
    """
    GET-Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ñ ÑĞºÑĞ¿Ğ¾Ğ½ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¿Ğ¾Ğ²Ñ‚Ğ¾Ñ€Ğ°Ğ¼Ğ¸.
    Ğ’Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ€Ğ°ÑĞ¿Ğ°Ñ€ÑĞµĞ½Ğ½Ñ‹Ğ¹ JSON Ğ¸Ğ»Ğ¸ None.
    """
    attempt = 0
    while attempt <= retries:
        try:
            r = requests.get(
                url,
                params=params,
                timeout=15,
                headers={"User-Agent": "VayboMeter"},
            )
            r.raise_for_status()
            return r.json()
        except Exception as e:
            attempt += 1
            if attempt > retries:
                logging.warning(
                    "%s â€“ %s (attempts=%d)", url.split("/")[2], e, attempt
                )
                return None
            time.sleep(0.5 * attempt)  # 0.5 s, 1 s, â€¦

def _get(url: str, **params):
    """Ğ˜ÑÑ‚Ğ¾Ñ€Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ°Ğ»Ğ¸Ğ°Ñ: `_get_retry` Ñ Ğ´Ğ²ÑƒĞ¼Ñ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ°Ğ¼Ğ¸."""
    return _get_retry(url, retries=2, **params)
