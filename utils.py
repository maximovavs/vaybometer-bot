#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import math
import requests
import logging
import random
import time          # ‚Üê –¥–æ–±–∞–≤–∏–ª–∏
import pendulum


# ‚îÄ‚îÄ —Ä—É–º–±—ã –¥–ª—è –∫–æ–º–ø–∞—Å–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
COMPASS = [
    "N","NNE","NE","ENE","E","ESE","SE","SSE",
    "S","SSW","SW","WSW","W","WNW","NW","NNW"
]

def compass(deg: float) -> str:
    """–ß–∏—Å–ª–æ–≤–æ–π —É–≥–æ–ª 0‚Äì360¬∞ ‚Üí –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ N/NE/E‚Ä¶."""
    return COMPASS[int((deg / 22.5) + .5) % 16]

def clouds_word(pc: int) -> str:
    """–ü—Ä–æ—Ü–µ–Ω—Ç –æ–±–ª–∞—á–Ω–æ—Å—Ç–∏ ‚Üí '—è—Å–Ω–æ'/'–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è'/'–ø–∞—Å–º—É—Ä–Ω–æ'."""
    if pc < 25:
        return "—è—Å–Ω–æ"
    if pc < 70:
        return "–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è"
    return "–ø–∞—Å–º—É—Ä–Ω–æ"

def wind_phrase(km_h: float) -> str:
    """–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞ ‚Üí '—à—Ç–∏–ª—å'/'—Å–ª–∞–±—ã–π'/'—É–º–µ—Ä–µ–Ω–Ω—ã–π'/'—Å–∏–ª—å–Ω—ã–π'."""
    if km_h < 2:
        return "—à—Ç–∏–ª—å"
    if km_h < 8:
        return "—Å–ª–∞–±—ã–π"
    if km_h < 14:
        return "—É–º–µ—Ä–µ–Ω–Ω—ã–π"
    return "—Å–∏–ª—å–Ω—ã–π"

def safe(v, unit: str = "") -> str:
    """–ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç None ‚Üí '‚Äî', —á–∏—Å–ª–æ ‚Üí —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É."""
    if v in (None, "None", "‚Äî"):
        return "‚Äî"
    if isinstance(v, (int, float)):
        return f"{v:.1f}{unit}"
    return f"{v}{unit}"

# ‚îÄ‚îÄ AQI ‚Üí —Ü–≤–µ—Ç–æ–∫—Ä—É–∂–æ–∫-—ç–º–æ–¥–∑–∏ –ø–æ US-EPA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def aqi_color(aqi: int | float | str) -> str:
    """AQI ‚Üí üü¢üü°üü†üî¥üü£ (—Å—Ç—Ä–æ–∫–∞)."""
    if aqi == "‚Äî":
        return "‚ö™"
    aqi = float(aqi)
    if aqi <= 50:
        return "üü¢"
    if aqi <= 100:
        return "üü°"
    if aqi <= 150:
        return "üü†"
    if aqi <= 200:
        return "üî¥"
    if aqi <= 300:
        return "üü£"
    return "üü§"

# ‚îÄ‚îÄ ¬´–§–∞–∫—Ç –¥–Ω—è¬ª –ø–æ –¥–∞—Ç–µ –∏–ª–∏ –∑–∞–ø–∞—Å–Ω–æ–π ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
FACTS = {
    "05-11": "11 –º–∞—è ‚Äî –î–µ–Ω—å –º–æ—Ä—Å–∫–æ–≥–æ –±—Ä–∏–∑–∞ –Ω–∞ –ö–∏–ø—Ä–µ üå¨Ô∏è",
    "06-08": "8 –∏—é–Ω—è 2004 –≥. ‚Äî —Ç—Ä–∞–Ω–∑–∏—Ç –í–µ–Ω–µ—Ä—ã –ø–æ –¥–∏—Å–∫—É –°–æ–ª–Ω—Ü–∞ üåû",
    "07-20": "20 –∏—é–ª—è ‚Äî –Ω–∞ –ö–∏–ø—Ä–µ —Å–æ–±–∏—Ä–∞—é—Ç –ø–µ—Ä–≤—ã–π —É—Ä–æ–∂–∞–π –≤–∏–Ω–æ–≥—Ä–∞–¥–∞ üçá",
}

def get_fact(date_obj: pendulum.Date) -> str:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ñ–∞–∫—Ç –ø–æ –∫–ª—é—á—É MM-DD –∏–∑ —Å–ª–æ–≤–∞—Ä—è FACTS –∏–ª–∏ –∑–∞–ø–∞—Å–Ω–æ–π —Ñ–∞–∫—Ç."""
    key = date_obj.format("MM-DD")
    return FACTS.get(key, "–ù–∞ –ö–∏–ø—Ä–µ –≤ –≥–æ–¥—É ‚âà340 —Å–æ–ª–Ω–µ—á–Ω—ã—Ö –¥–Ω–µ–π ‚òÄÔ∏è")

# ‚îÄ‚îÄ –≠–º–æ–¥–∑–∏-–∏–∫–æ–Ω–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
WEATHER_ICONS = {
    "—è—Å–Ω–æ":       "‚òÄÔ∏è",
    "–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è": "üå§Ô∏è",
    "–ø–∞—Å–º—É—Ä–Ω–æ":   "‚òÅÔ∏è",
    "–¥–æ–∂–¥—å":      "üåßÔ∏è",
    "—Ç—É–º–∞–Ω":      "üåÅ",
}

AIR_EMOJI = {
    "—Ö–æ—Ä–æ—à–∏–π":      "üü¢",
    "—É–º–µ—Ä–µ–Ω–Ω—ã–π":    "üü°",
    "–≤—Ä–µ–¥–Ω—ã–π":      "üü†",
    "–æ—á. –≤—Ä–µ–¥–Ω—ã–π":  "üî¥",
    "–æ–ø–∞—Å–Ω—ã–π":      "üü£",
    "–Ω/–¥":          "‚ö™",
}

# ‚îÄ‚îÄ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ HTTP-–æ–±—ë—Ä—Ç–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def _get_retry(url: str, retries: int = 2, **params) -> dict | None:
    """
    GET-–∑–∞–ø—Ä–æ—Å —Å –ø–æ–≤—Ç–æ—Ä–∞–º–∏.
    ‚Ä¢ retries ‚Äî —Å–∫–æ–ª—å–∫–æ –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–• –ø–æ–ø—ã—Ç–æ–∫ —Å–¥–µ–ª–∞—Ç—å –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–π –Ω–µ—É–¥–∞—á–∏.
    ‚Ä¢ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç JSON-—Å–ª–æ–≤–∞—Ä—å –∏–ª–∏ None, –µ—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –Ω–µ —É–¥–∞–ª–∏—Å—å.
    """
    attempt = 0
    while attempt <= retries:
        try:
            r = requests.get(
                url,
                params=params,
                timeout=15,
                headers={"User-Agent": "VayboMeter"}
            )
            r.raise_for_status()
            return r.json()
        except Exception as e:
            attempt += 1
            if attempt > retries:
                host = url.split("/")[2]
                logging.warning("%s ‚Äì %s (attempts=%d)", host, e, attempt)
                return None
            # —ç–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –ø–∞—É–∑–∞ 0.5 / 1.0 —Å–µ–∫ ‚Ä¶
            time.sleep(0.5 * attempt)

def _get(url: str, **params) -> dict | None:          # <- —Å—Ç–∞—Ä—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    """–û–±—ë—Ä—Ç–∫–∞ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏: –≤—ã–∑—ã–≤–∞–µ—Ç _get_retry —Å 2 –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏."""
    return _get_retry(url, retries=2, **params)
