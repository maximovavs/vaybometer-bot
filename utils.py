#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import math, time, random, logging, requests, pendulum

# â”€â”€ Ñ€ÑƒÐ¼Ð±Ñ‹ ÐºÐ¾Ð¼Ð¿Ð°ÑÐ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
COMPASS = [
    "N","NNE","NE","ENE","E","ESE","SE","SSE",
    "S","SSW","SW","WSW","W","WNW","NW","NNW"
]

def compass(deg: float) -> str:
    return COMPASS[int((deg/22.5)+.5) % 16]

def clouds_word(pc: int) -> str:
    if pc < 25:  return "ÑÑÐ½Ð¾"
    if pc < 70:  return "Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ"
    return "Ð¿Ð°ÑÐ¼ÑƒÑ€Ð½Ð¾"

def wind_phrase(km_h: float) -> str:
    if km_h < 2:   return "ÑˆÑ‚Ð¸Ð»ÑŒ"
    if km_h < 8:   return "ÑÐ»Ð°Ð±Ñ‹Ð¹"
    if km_h < 14:  return "ÑƒÐ¼ÐµÑ€ÐµÐ½Ð½Ñ‹Ð¹"
    return "ÑÐ¸Ð»ÑŒÐ½Ñ‹Ð¹"

def safe(v, unit=""):
    if v in (None, "None", "â€”"):
        return "â€”"
    return f"{v:.1f}{unit}" if isinstance(v, (int,float)) else f"{v}{unit}"

# â”€â”€ AQI Ñ†Ð²ÐµÑ‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def aqi_color(aqi):
    if aqi == "â€”": return "âšª"
    aqi = float(aqi)
    if aqi<=50:  return "ðŸŸ¢"
    if aqi<=100: return "ðŸŸ¡"
    if aqi<=150: return "ðŸŸ "
    if aqi<=200: return "ðŸ”´"
    if aqi<=300: return "ðŸŸ£"
    return "ðŸŸ¤"

# â”€â”€ Â«Ð¤Ð°ÐºÑ‚ Ð´Ð½ÑÂ» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FACTS = {
    "05-11": "11 Ð¼Ð°Ñ â€” Ð”ÐµÐ½ÑŒ Ð¼Ð¾Ñ€ÑÐºÐ¾Ð³Ð¾ Ð±Ñ€Ð¸Ð·Ð° Ð½Ð° ÐšÐ¸Ð¿Ñ€Ðµ ðŸŒ¬ï¸",
    "06-08": "8 Ð¸ÑŽÐ½Ñ 2004 Ð³. â€” Ñ‚Ñ€Ð°Ð½Ð·Ð¸Ñ‚ Ð’ÐµÐ½ÐµÑ€Ñ‹ Ð¿Ð¾ Ð´Ð¸ÑÐºÑƒ Ð¡Ð¾Ð»Ð½Ñ†Ð° ðŸŒž",
    "07-20": "20 Ð¸ÑŽÐ»Ñ â€” Ð½Ð° ÐšÐ¸Ð¿Ñ€Ðµ ÑÐ¾Ð±Ð¸Ñ€Ð°ÑŽÑ‚ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÑƒÑ€Ð¾Ð¶Ð°Ð¹ Ð²Ð¸Ð½Ð¾Ð³Ñ€Ð°Ð´Ð° ðŸ‡",
}
def get_fact(d: pendulum.Date) -> str:
    return FACTS.get(d.format("MM-DD"), "ÐÐ° ÐšÐ¸Ð¿Ñ€Ðµ Ð² Ð³Ð¾Ð´Ñƒ â‰ˆ340 ÑÐ¾Ð»Ð½ÐµÑ‡Ð½Ñ‹Ñ… Ð´Ð½ÐµÐ¹ â˜€ï¸")

# â”€â”€ Ð¸ÐºÐ¾Ð½ÐºÐ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
WEATHER_ICONS = {"ÑÑÐ½Ð¾":"â˜€ï¸","Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ":"ðŸŒ¤ï¸","Ð¿Ð°ÑÐ¼ÑƒÑ€Ð½Ð¾":"â˜ï¸","Ð´Ð¾Ð¶Ð´ÑŒ":"ðŸŒ§ï¸","Ñ‚ÑƒÐ¼Ð°Ð½":"ðŸŒ"}
AIR_EMOJI     = {"Ñ…Ð¾Ñ€Ð¾ÑˆÐ¸Ð¹":"ðŸŸ¢","ÑƒÐ¼ÐµÑ€ÐµÐ½Ð½Ñ‹Ð¹":"ðŸŸ¡","Ð²Ñ€ÐµÐ´Ð½Ñ‹Ð¹":"ðŸŸ ","Ð¾Ñ‡. Ð²Ñ€ÐµÐ´Ð½Ñ‹Ð¹":"ðŸ”´","Ð¾Ð¿Ð°ÑÐ½Ñ‹Ð¹":"ðŸŸ£","Ð½/Ð´":"âšª"}

# â”€â”€ K-index Â«ÑÐ²ÐµÑ‚Ð¾Ñ„Ð¾Ñ€Â» â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
K_COLOR = {                    # Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ñ‹ Ð²ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾
    "green":  range(0,4),      # 0â€“3
    "yellow": range(4,6),      # 4â€“5
    "red":    range(6,10),     # 6â€“9
}
def kp_emoji(kp: float) -> str:
    k = int(round(kp))
    if k in K_COLOR["green"]:  return "ðŸŸ¢"
    if k in K_COLOR["yellow"]: return "ðŸŸ¡"
    return "ðŸ”´"

# â”€â”€ Ñ‚Ñ€ÐµÐ½Ð´ Ð´Ð°Ð²Ð»ÐµÐ½Ð¸Ñ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def pressure_trend(w: dict) -> str:
    """
    âš™  w â€“ Ð¾Ð±ÑŠÐµÐºÑ‚ get_weather().
    â–¸ Ð‘ÐµÑ€Ñ‘Ð¼ Ð¼Ð°ÑÑÐ¸Ð² hourly['surface_pressure']:
      â€¢ Ñ€Ð°Ð·Ð½Ð¸Ñ†Ð° Ð±ÑƒÐ´ÑƒÑ‰ÐµÐ³Ð¾ Ñ‡Ð°ÑÐ° â€“ >2 Ð³ÐŸÐ° â†’ â†‘
      â€¢ <-2 Ð³ÐŸÐ° â†’ â†“
      â€¢ Ð¸Ð½Ð°Ñ‡Ðµ â†’ â†’
    """
    hp = w.get("hourly", {}).get("surface_pressure", [])
    if len(hp) < 2:
        return "â†’"
    diff = hp[1] - hp[0]      # Ð±Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐ¸Ð¹ Ñ‡Ð°Ñ
    if diff >= 2:   return "â†‘"
    if diff <= -2:  return "â†“"
    return "â†’"

# â”€â”€ HTTP-Ð¾Ð±Ñ‘Ñ€Ñ‚ÐºÐ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def _get_retry(url: str, retries: int = 2, **params):
    attempt = 0
    while attempt <= retries:
        try:
            r = requests.get(url, params=params, timeout=15,
                             headers={"User-Agent": "VayboMeter"})
            r.raise_for_status()
            return r.json()
        except Exception as e:
            attempt += 1
            if attempt > retries:
                logging.warning("%s â€“ %s (attempts=%d)", url.split('/')[2], e, attempt)
                return None
            time.sleep(0.5 * attempt)   # 0.5s, 1.0s â€¦

def _get(url: str, **params):
    return _get_retry(url, retries=2, **params)
